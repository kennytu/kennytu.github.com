<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[江湖險惡，我從來都不輕易留下我的姓名。]]></title>
  <link href="http://kennytu.github.io/atom.xml" rel="self"/>
  <link href="http://kennytu.github.io/"/>
  <updated>2015-12-11T16:18:21+08:00</updated>
  <id>http://kennytu.github.io/</id>
  <author>
    <name><![CDATA[Kenny Tu]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Sails Socket.io基本概念 - Rooms and Streams]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/11/sails-socket-dot-io-2/"/>
    <updated>2015-12-11T15:30:30+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/11/sails-socket-dot-io-2</id>
    <content type="html"><![CDATA[<p>好的, 這一篇是接著<strong>stenio123</strong>老大的第二章節, 也就是 <a href="http://impacta.us/sails-with-socket-io-part-24/" target="_blank">part 2 – Sails js Socket.io intermediate – rooms and streams</a></p>

<p>這一篇的練習做完, 大致上就可以掌握sails socket.io的百分之七十的用法了</p>

<p>我們先把程式碼寫一寫</p>

<p>這個程式碼是接續自上一篇, 我們繼續在socket_test的專案下執行</p>

<!--more-->


<pre><code>sails generate controller TeamNews
</code></pre>

<p>然後修改一下檔案</p>

<figure class='code'><figcaption><span>api\controllers\TeamNewsController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * TeamNewsController</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @description :: Server-side logic for managing Teamnews</span>
</span><span class='line'><span class="cm"> * @help        :: See http://sailsjs.org/#!/documentation/concepts/Controllers</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">index</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">teamNames</span> <span class="o">=</span> <span class="p">[{</span><span class="nx">name</span><span class="o">:</span><span class="s1">&#39;blackhawks&#39;</span><span class="p">},</span> <span class="p">{</span><span class="nx">name</span><span class="o">:</span><span class="s1">&#39;lightning&#39;</span><span class="p">}];</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">hawks_fans</span> <span class="o">=</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">(</span><span class="s1">&#39;blackhawks&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">lightning_fans</span> <span class="o">=</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">(</span><span class="s1">&#39;lightning&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">({</span>
</span><span class='line'>            <span class="nx">teams</span><span class="o">:</span> <span class="nx">teamNames</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">hawksFans</span><span class="o">:</span> <span class="nx">hawks_fans</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">lightningFans</span><span class="o">:</span> <span class="nx">lightning_fans</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">broadcastnews</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>        <span class="nx">data</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;team&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">data</span><span class="p">.</span><span class="nx">news</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;news&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">rooms</span> <span class="o">=</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">rooms</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">hawks</span> <span class="o">=</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">(</span><span class="s2">&quot;blackhawks&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">lightning</span> <span class="o">=</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">(</span><span class="s2">&quot;lightning&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Available rooms: &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">rooms</span><span class="p">));</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;subscribers hawks: &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">hawks</span><span class="p">));</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;subscribers lightning: &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">lightning</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="s2">&quot;news&quot;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">blastnews</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">news</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;news&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">blast</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="nx">news</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="c1">//this is how we keep track of how many sockets each team has in their room,</span>
</span><span class='line'>    <span class="nx">joinroomfans</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;joining room fans socket id&quot;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">,</span> <span class="s1">&#39;blackhawksFans&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">,</span> <span class="s1">&#39;lightningFans&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="s1">&#39;blackhawksFans&#39;</span><span class="p">,</span> <span class="s1">&#39;updatedblackhawks&#39;</span><span class="p">,</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">(</span><span class="s1">&#39;blackhawks&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="s1">&#39;lightningFans&#39;</span><span class="p">,</span> <span class="s1">&#39;updatedlightning&#39;</span><span class="p">,</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">(</span><span class="s1">&#39;lightning&#39;</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="c1">//this is how a socket joins room to receive news of their team</span>
</span><span class='line'>    <span class="nx">joinroom</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">teamName</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;teamName&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">,</span><span class="nx">teamName</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;Socket &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;joined room: &#39;</span> <span class="o">+</span> <span class="nx">teamName</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">//teamName+&#39;Fans&#39; is name of the room, &#39;updated&#39;+teamName is name of event</span>
</span><span class='line'>        <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="nx">teamName</span><span class="o">+</span><span class="s1">&#39;Fans&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="o">+</span><span class="nx">teamName</span><span class="p">,</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">(</span><span class="nx">teamName</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="c1">//leave room from team news</span>
</span><span class='line'>    <span class="nx">leaveroom</span><span class="o">:</span><span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">teamName</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s2">&quot;teamName&quot;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">leave</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">,</span><span class="nx">teamName</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span> <span class="s1">&#39;Socket&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span> <span class="o">+</span> <span class="s1">&#39;left room: &#39;</span> <span class="o">+</span> <span class="nx">teamName</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">//teamName+&#39;Fans&#39; is name of the room, &#39;updated&#39;+teamName is name of event</span>
</span><span class='line'>        <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">broadcast</span><span class="p">(</span><span class="nx">teamName</span><span class="o">+</span><span class="s1">&#39;Fans&#39;</span><span class="p">,</span> <span class="s1">&#39;updated&#39;</span><span class="o">+</span><span class="nx">teamName</span><span class="p">,</span> <span class="nx">sails</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">subscribers</span><span class="p">(</span><span class="nx">teamName</span><span class="p">).</span><span class="nx">length</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>接著新增<code>views\teamnews\index.ejs</code></p>

<figure class='code'><figcaption><span>views\teamnews\index.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">Sails</span> <span class="nx">js</span> <span class="kd">with</span> <span class="nx">socket</span> <span class="nx">io</span> <span class="nx">tutorial</span> <span class="o">-</span> <span class="nx">part</span> <span class="mi">2</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'><span class="nx">You</span> <span class="nx">can</span> <span class="nx">check</span> <span class="nx">the</span> <span class="nx">tutorial</span> <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;http://www.impacta.us/blog&quot;</span><span class="o">&gt;</span><span class="nx">here</span><span class="o">&lt;</span><span class="err">/a&gt;.</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user/&quot;</span><span class="o">&gt;</span><span class="nx">Part1</span> <span class="o">&lt;</span><span class="err">/a&gt; Part2 Part3 Part4</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">teams</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">select</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;teamNameSelect&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">option</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;0&quot;</span> <span class="nx">selected</span><span class="o">=</span><span class="s2">&quot;selected&quot;</span> <span class="nx">style</span><span class="o">=</span><span class="s2">&quot;display:none;&quot;</span><span class="o">&gt;</span><span class="nx">Select</span> <span class="nx">team</span><span class="o">&lt;</span><span class="err">/option&gt;</span>
</span><span class='line'>     <span class="o">&lt;%</span> <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">teams</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">team</span><span class="p">)</span> <span class="p">{</span>  <span class="o">%&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">option</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%=team.name%&gt;&quot;</span><span class="o">&gt;&lt;%=</span><span class="nx">team</span><span class="p">.</span><span class="nx">name</span><span class="o">%&gt;&lt;</span><span class="err">/option&gt;</span>
</span><span class='line'>    <span class="o">&lt;%</span> <span class="p">})</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/select&gt;</span>
</span><span class='line'><span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;news&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;news&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;type team news here&quot;</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">button</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span><span class="o">&gt;</span><span class="nx">Submit</span> <span class="nx">team</span> <span class="nx">news</span><span class="o">!&lt;</span><span class="err">/button&gt; or &lt;button id=&quot;blast&quot;&gt;Blast to everyone&lt;/button&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">Subscribe</span> <span class="nx">to</span> <span class="nx">Chicago</span> <span class="nx">Blackhawks</span> <span class="nx">news</span><span class="o">&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'><span class="err">#</span> <span class="nx">of</span> <span class="nx">subscribed</span> <span class="nx">fans</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;blackhawksFans&quot;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">br</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">button</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;gohawks&quot;</span><span class="o">&gt;</span><span class="nx">Go</span> <span class="nx">Hawks</span><span class="o">!&lt;</span><span class="err">/button&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;blackhawks&quot;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/ul&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">button</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;nohawks&quot;</span><span class="o">&gt;</span><span class="nx">Unsubscribe</span> <span class="nx">to</span> <span class="nx">Hawks</span><span class="o">!&lt;</span><span class="err">/button&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">Subscribe</span> <span class="nx">to</span> <span class="nx">Tampa</span> <span class="nx">Lightning</span> <span class="nx">news</span><span class="o">&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'><span class="err">#</span> <span class="nx">of</span> <span class="nx">subscribed</span> <span class="nx">fans</span><span class="o">:</span> <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;lightningFans&quot;</span><span class="o">&gt;&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">br</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">button</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;gotampa&quot;</span><span class="o">&gt;</span><span class="nx">Go</span> <span class="nx">Tampa</span><span class="o">!&lt;</span><span class="err">/button&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;lightning&quot;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/ul&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">button</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;notampa&quot;</span><span class="o">&gt;</span><span class="nx">Unsubscribe</span> <span class="nx">to</span> <span class="nx">Tampa</span><span class="o">!&lt;</span><span class="err">/button&gt;</span>
</span><span class='line'>
</span><span class='line'> <span class="c">&lt;!--</span> <span class="nx">END</span> <span class="nx">Page</span> <span class="nx">Content</span> <span class="o">--&gt;</span>
</span><span class='line'><span class="o">&lt;%</span> <span class="nx">block</span><span class="p">(</span><span class="s1">&#39;localScripts&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;script src=&quot;/view_specific/teamnews_index_misc.js&quot;&gt;&lt;/script&gt;&#39;</span><span class="p">)</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>再來是<code>assets\view_specific\teamnews_index_misc.js</code></p>

<figure class='code'><figcaption><span>assets\view_specific\teamnews_index_misc.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//when page loads, register this socket to receive notification of new fans(sockets) subscribed</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/teamnews/joinroomfans/&#39;</span><span class="p">,</span> <span class="p">{});</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** event handling for Fan room */</span>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;updatedblackhawks&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot; fan response is &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">));</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#blackhawksFans&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;updatedlightning&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot; fan response is &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">));</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#lightningFans&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">response</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//adds listener and what to do once receives event notification</span>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;response is &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">response</span><span class="p">));</span>
</span><span class='line'>    <span class="c1">//if it is a sails.socket.broadcast</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;blackhawks&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#blackhawks&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">news</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="s1">&#39;lightning&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#lightning&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="nx">response</span><span class="p">.</span><span class="nx">news</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="c1">//if it is sails.socket.blast</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#blackhawks&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="nx">response</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#lightning&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="nx">response</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//subscribes to Blackhawks messages (code on TeamNewsController.subscribe)</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gohawks&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/teamnews/joinroom/&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">teamName</span><span class="o">:</span> <span class="s1">&#39;blackhawks&#39;</span><span class="p">});</span>
</span><span class='line'>    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;subscribed to Hawks news!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="c1">//unsubscribes to Blackhawks messages (code on TeamNewsController.subscribe)</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#nohawks&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/teamnews/leaveroom/&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">teamName</span><span class="o">:</span> <span class="s1">&#39;blackhawks&#39;</span><span class="p">});</span>
</span><span class='line'>    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;unsubscribed to Hawks news!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//subscribes to Lightning messages (code on TeamNewsController.subscribe)</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#gotampa&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/teamnews/joinroom/&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">teamName</span><span class="o">:</span> <span class="s1">&#39;lightning&#39;</span><span class="p">});</span>
</span><span class='line'>    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;subscribed to Lightning news!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="c1">//unsubscribes to Lightning messages (code on TeamNewsController.subscribe)</span>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#notampa&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/teamnews/leaveroom/&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">teamName</span><span class="o">:</span> <span class="s1">&#39;lightning&#39;</span><span class="p">});</span>
</span><span class='line'>    <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;unsubscribed to Lightning news!&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#submit&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#teamNameSelect&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/teamnews/broadcastnews/&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">team</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#teamNameSelect&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(),</span>
</span><span class='line'>            <span class="nx">news</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#news&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;please select team!&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#blast&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/teamnews/blastnews/&#39;</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">news</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#news&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>最後修改一下<code>config\routes.js</code>, 將首頁設定成TeamNews的index</p>

<figure class='code'><figcaption><span>config\routes.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'> <span class="s1">&#39;/&#39;</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">controller</span><span class="o">:</span> <span class="s1">&#39;TeamNews&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;index&#39;</span>
</span><span class='line'>     <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, 大功告成.</p>

<p>存檔, 從新啟動sails.</p>

<pre><code>sails lift
</code></pre>

<p>然後在瀏覽器輸入localhost:1337</p>

<p>就可以開始來玩玩看嚕!</p>

<p>記得開啟瀏覽器的除錯模式(例如firefox的firebug)</p>

<p>觀察前端以及後端的log</p>

<h3>參考資料</h3>

<ul>
<li><a href="http://sailsjs.org/documentation/reference/web-sockets/socket-client" target="_blank">Socket Client (sails.io.js)</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails Socket.io基本概念 - Watch and Subscribe]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/10/sails-socket-dot-io/"/>
    <updated>2015-12-10T11:09:01+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/10/sails-socket-dot-io</id>
    <content type="html"><![CDATA[<p>OK, 由於Irl先生接下來會用到socket.io, 整合到activityOverlord專案中</p>

<p>因為Irl先生是用舊版的Sails, 也就是Sails 0.9的, 而在Sails 0.11之後, sails對於socket.io的支援改動滿大的</p>

<p>所以我就上網找了一些相容於sails 0.11的專案來練習</p>

<p>先講幾個用法上的觀念</p>

<ol>
<li>Sails已經將socket.io整合進自己的架構, 你可以在<code>assets\js\dependencies\</code>找到<code>sails.io.js</code>這個檔案, 這個檔案就是socket.io的精隨了</li>
<li>Sails將socket.io的使用整合進它自己的MVC架構, 也就是說, 我們在操控socket.io這些方法的時候, 大部分是在Controller這邊處理, 我們會在後面的例子中談到</li>
<li>Sails針對socket.io的用法有提供socket.io模式的Method,也有提供Sails本身Data Module的Method, 看你要用哪一種</li>
</ol>


<!--more-->


<p>以上幾個觀念, 詳細請參考<a href="http://sailsjs.org/documentation/reference/web-sockets/socket-client" target="_blank">Socket Client (sails.io.js)</a>, 老實說文件寫得有夠精簡的&hellip;. 看完也不知道怎麼用</p>

<p>好的, 接下來我們用例子來讓大家有感覺</p>

<p>本篇的實作是參考<strong>stenio123</strong>大哥的專案, 他的專案程式碼都放在他的Github, 請參考 <a href="https://github.com/stenio123/sails-socket-example" target="_blank">sails-socket-example</a></p>

<p>他也有寫了一個網誌來教學, 請看 <a href="http://impacta.us/sails-with-socket-io-part-14/" target="_blank">Sails with socket.io</a>, 不過他好像只寫了前兩篇, 後兩篇就沒著落了.</p>

<p>讓我們開始, 先建立一個Sails專案</p>

<pre><code>sails new socket_test

cd socket_test
</code></pre>

<p>先試試看可不可以Run</p>

<pre><code>sails lift
</code></pre>

<p>開啟瀏覽器, 輸入<code>localhost:1337</code> 看看結果</p>

<p>注意! 你在執行sails lift的時候有可能會發生缺少什麼module, 請看我上一篇網誌<strong>NPM的怪問題</strong>獲得可能的解答</p>

<p>第一次執行的時候, Sails會問你關於資料庫的存取問題, 到<code>config</code>目錄下的<code>models.js</code>, 把<code>migrate</code>改成 <code>'safe'</code>即可</p>

<p>OK, 沒問題的話, 接下來就開始來寫Code了</p>

<pre><code>socket_test&gt; sails generate api User
</code></pre>

<p>Sails會幫我們在<code>api</code>目錄下的<code>controllers</code>以及<code>models</code>這兩個目錄下, 產生相對應的檔案</p>

<p>我們先修改<code>api\controllers\UserController.js</code>, 把裡面的東西全刪掉, 將下面的程式複製貼上</p>

<figure class='code'><figcaption><span>UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">watchUser</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// watch for new User instances</span>
</span><span class='line'>        <span class="nx">User</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User watching &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">subscribeUser</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="c1">// subscribe client to model changes</span>
</span><span class='line'>        <span class="nx">User</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;User subscribed to &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">createpub</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">data_from_client</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">all</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">isSocket</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span> <span class="o">===</span> <span class="s1">&#39;POST&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">data_from_client</span><span class="p">)</span>
</span><span class='line'>                <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">data_from_client</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data_from_client</span><span class="p">);</span>
</span><span class='line'>                    <span class="nx">User</span><span class="p">.</span><span class="nx">publishCreate</span><span class="p">({</span><span class="nx">id</span><span class="o">:</span> <span class="nx">data_from_client</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">data_from_client</span><span class="p">.</span><span class="nx">name</span><span class="p">});</span>
</span><span class='line'>                <span class="p">})</span>
</span><span class='line'>                <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Error creating new User. Error: &#39;</span> <span class="o">+</span> <span class="nx">err</span><span class="p">);</span>
</span><span class='line'>                    <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">serverError</span><span class="p">(</span><span class="s1">&#39;Server encountered a problem. Please contact administrator.&#39;</span><span class="p">);</span>
</span><span class='line'>                <span class="p">});</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">badRequest</span><span class="p">(</span><span class="s1">&#39;Sorry, this endpoint only accessible via sockets.&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">({</span>
</span><span class='line'>            <span class="nx">welcomeMessage</span><span class="o">:</span> <span class="s1">&#39;Welcome to Sails + socket.io simple test. Please refrain from adding client logic on the server!&#39;</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>接著, 我們到<code>views</code>底下新增一個<code>user</code>的目錄, 在<code>user</code>目錄新增一個<code>index.ejs</code>的檔案</p>

<figure class='code'><figcaption><span>views\user\index.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;%=</span> <span class="nx">welcomeMessage</span> <span class="o">%&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">br</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;go-data&quot;</span><span class="o">&gt;</span><span class="nx">Submit</span><span class="o">!&lt;</span><span class="err">/button&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">br</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">ul</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;user-list&quot;</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/ul&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;%</span> <span class="nx">block</span><span class="p">(</span><span class="s1">&#39;localScripts&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;script src=&quot;/view_specific/user_index_misc.js&quot;&gt;&lt;/script&gt;&#39;</span><span class="p">)</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>這個程式碼解釋一下, Sails有提供layout, partial and block template functions for the EJS template engine.</p>

<p>其實就是express 3.x然後使用ejs-local的範本(因為sails就是架構在express上面的呀)</p>

<p>其中<code>&lt;% block ... %&gt;</code>, 裡面的意思是說, 這個local的javasript, 就只有給這個index.ejs用, 不會被其他的網頁包含</p>

<p>這個技巧在動態網頁互動很常使用到, 所以可以學習一下</p>

<p>要很注意的是, 我在<code>&lt;% block</code> 這個標籤, 並沒有加上 <strong>-</strong> 這個,</p>

<p>也就是說, 我沒有用<code>&lt;%- block ... %&gt;</code>這個加上<strong>-</strong>的方式, 網路上有不少人都會加上這個dash sign, 但這會造成一些錯誤, 我們會在附錄中解說</p>

<p>但在sails的使用上, 我們還得注意到另外一個地方, 若要使用這個<code>&lt;% block ... %&gt;</code>標籤, 我們需要去修改<code>layout.ejs</code></p>

<p>在<code>&lt;!--SCRIPTS END--&gt;</code>下面, 加上一段話, 程式碼如下</p>

<figure class='code'><figcaption><span>views\layout.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>    <span class="c">&lt;!--</span><span class="nx">SCRIPTS</span><span class="o">--&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;/js/dependencies/sails.io.js&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">script</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;/js/dependencies/jquery-1.11.1.min.js&quot;</span><span class="o">&gt;&lt;</span><span class="err">/script&gt;</span>
</span><span class='line'>    <span class="c">&lt;!--</span><span class="nx">SCRIPTS</span> <span class="nx">END</span><span class="o">--&gt;</span>
</span><span class='line'>    <span class="o">&lt;%-</span> <span class="nx">blocks</span><span class="p">.</span><span class="nx">localScripts</span> <span class="o">%&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/body&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意到我們在<code>&lt;!--SCRIPTS END--&gt;</code>下加入了<code>&lt;%- blocks.localScripts %&gt;</code></p>

<p>簡單介紹一下layout.ejs, 被<code>&lt;!--SCRIPTS--&gt;</code>和<code>&lt;!--SCRIPTS END--&gt;</code>包住的這兩行程式碼, 是Sails自動產生的,</p>

<p>Sails會根據我們放在<code>assets\js\dependencies</code>裡面的檔案, 把這些檔案的檔名掃描進來, 放到<code>&lt;!--SCRIPTS--&gt;</code>和<code>&lt;!--SCRIPTS END--&gt;</code>中間</p>

<p>那你會想說, 如果我的javascript有先後順序的話, 我要怎麼調整順序呢?</p>

<p>請到<code>tasks\pipeline.js</code>, 找到<code>jsFilesToInject</code>這個區段, 參考底下</p>

<figure class='code'><figcaption><span>pipeline.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Client-side javascript files to inject in order</span>
</span><span class='line'><span class="c1">// (uses Grunt-style wildcard/glob/splat expressions)</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">jsFilesToInject</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Load sails.io before everything else</span>
</span><span class='line'>  <span class="s1">&#39;js/dependencies/sails.io.js&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Dependencies like jQuery, or Angular are brought in here</span>
</span><span class='line'>  <span class="s1">&#39;js/dependencies/**/*.js&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// All of the rest of your client-side js files</span>
</span><span class='line'>  <span class="c1">// will be injected here in no particular order.</span>
</span><span class='line'>  <span class="s1">&#39;js/**/*.js&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Use the &quot;exclude&quot; operator to ignore files</span>
</span><span class='line'>  <span class="c1">// &#39;!js/ignore/these/files/*.js&#39;</span>
</span><span class='line'><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>若要更改順序, 就把你想要的javascript按照寫在這邊, 就可以了, 上面的說明應該滿清楚的</p>

<p>好的, views/user/index.ejs完成之後, 我們要來處理Client端的介面</p>

<p>到<code>assets</code>這個路徑下, 新增一個<code>view_specific</code>的目錄, 然後在此目錄下新增<code>user_index_misc.js</code>這個檔案</p>

<p>檔案內容如下</p>

<figure class='code'><figcaption><span>user_index_misc.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//sends this socket id so it can be subscribed at the controller</span>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/user/watchUser&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">resData</span><span class="p">,</span> <span class="nx">jwres</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">resData</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//adds listener and what to do once receives event notification</span>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">obj</span><span class="p">){</span>
</span><span class='line'>    <span class="c1">//if(obj.verb ===&#39;created&#39;){</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;chat event is &#39;</span><span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">obj</span><span class="p">));</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#user-list&quot;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="s1">&#39;&lt;li&gt;&#39;</span> <span class="o">+</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39;&lt;/li&gt;&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#go-data&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">io</span><span class="p">.</span><span class="nx">socket</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">&#39;/user/createpub/&#39;</span><span class="p">,{</span><span class="nx">name</span><span class="o">:</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#name&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">()});</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#name&quot;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>新增完成之後, 最後一件事情就是, 將Jquery放到<code>assets\js\dependencies\</code></p>

<p>也就是上去Jquery的網站, 去下載Jquery的檔案, 1.x版本或者2.x版都可以</p>

<p>例如我這邊就是<code>assets\js\dependencies\jquery-1.11.1.min.js</code></p>

<p>下載完放好之後, 你就會在layout.ejs裡面看到sails已經將jquery-1.11.1.min.js放進去了</p>

<p>OK, 事前準備終於完成了</p>

<p>啊! 還有一個要改, 就是首頁的Route</p>

<p>到<code>config\routes.js</code>, 把<code>view: 'homepage'</code>拿掉, 改成以下</p>

<figure class='code'><figcaption><span>config\routes.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>    <span class="s1">&#39;/&#39;</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">controller</span><span class="o">:</span> <span class="s1">&#39;User&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39;index&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣就確保我們的首頁就是User底下的index了</p>

<p>現在, 執行以下指令</p>

<pre><code>sails lift
</code></pre>

<p>開啟瀏覽器, 輸入localhost:1337</p>

<p>會出現一個讓我們輸入client的畫面, 我們使用firefox的firebug開啟除錯視窗, 然後觀察輸出的訊息 (也要觀察後台的訊息唷)</p>

<p>若沒有問題的話, 這就是我們stenio123大哥的第一部分的示範</p>

<h2>附錄</h2>

<p>上面提到Sails有提供layout, partial and block template functions for the EJS template engine.</p>

<p>然後提到<code>&lt;%- block ... %&gt;</code>這個加上<strong>-</strong>的方式</p>

<p>這邊有個觀念是, 在ejs中, 若使用 <code>&lt;%-</code>這個有dash符號的, 那麼ejs就會去執行被<code>&lt;%-</code>包含起來的javascript程式碼. 專業一點的說法就是, 我們可以藉由這個<code>&lt;%-</code>符號, 來注入(inject)我們的javascript的程式碼.</p>

<p>另外一方面, 為什麼提到上述我們在使用<code>&lt;% block</code>這個tag的時候, 不能加dash呢? 是因為若我們使用了<code>&lt;%- block</code>, ejs會做兩次動作, 第一次是先執行要注入的程式碼, 也就是在<code>&lt;%- block</code>包含的javascript, 然後, 將此段javascript轉為此頁面的一部分, 結果, 當瀏覽器執行到此javascript的時候, 又會在執行一次, 結果造成了執行兩次的誤動作.</p>

<p>這樣會有什麼問題呢?</p>

<p>一個問題就是, 當ejs在執行第一次的注入javascript的時候, 若這個javascript有相依其他的javascript, 例如JQuery的時候, 它會發生找不到相依的錯誤, 直到第二次, 當瀏覽器依照正確的順序將相依的javascript匯入的時候, 第二次執行就沒有問題&hellip;</p>

<p>以上的討論可以參考 <a href="http://stackoverflow.com/questions/22112763/sails-js-how-to-inject-a-js-file-to-a-specific-route" target="_blank">Sails.js - How to inject a js file to a specific route?</a> 這個討論串</p>

<p>另外, 關於EJS的一些概念, 請參考底下網站</p>

<ul>
<li><p><a href="http://www.embeddedjs.com/getting_started.html" target="_blank">Getting Started with EJS</a></p></li>
<li><p><a href="http://blogger.gtwang.org/2014/02/ejs-embedded-javascript.html" target="_blank">EJS：Client 端嵌入式（Embedded）JavaScript</a></p></li>
<li><p><a href="http://ccc.nqu.edu.tw/wd.html#wp:ejs" target="_blank">ejs 樣板引擎</a></p></li>
<li><p><a href="http://www.embeddedjs.com/screencast/index.html" target="_blank">Clean AJAX with EJS</a></p></li>
</ul>


<h2>Sails不錯的簡報</h2>

<ul>
<li><a href="http://www.slideshare.net/stenio123/sails-js-intro-impactaus" target="_blank">ails-js-intro-impactaus</a>, 第21頁, 很棒的介紹!</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[NPM的怪問題]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/09/npm-weird-issue/"/>
    <updated>2015-12-09T20:13:55+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/09/npm-weird-issue</id>
    <content type="html"><![CDATA[<p>好的, 這篇我要來好好的念一下NPM, 也就是 package manager for node.js</p>

<p>這真的太令我生氣啦!!!</p>

<p>如果你是用<strong>WIN7</strong>&hellip; 對! 就是<strong>WIN7</strong>, 你可能會遇到底下我遇到的問題</p>

<p>當你去了官網 <a href="https://nodejs.org/en/">nodejs.org</a> 下載Windows的安裝包, 安裝完成之後, 通常<code>npm</code>都會一起被安裝進去了</p>

<p>這個時候你開啟<code>cmd</code>, 輸入<code>node</code>或者<code>npm</code>, 應該都已經可以執行</p>

<!--more-->


<p>好的, 然後你就用了一段時間, 使用<code>npm install -g</code>巴拉巴拉 用的很高興</p>

<p>突然間, 你看到網路上, 欸! 有<code>node.js</code>以及<code>npm</code>的<strong>更新</strong>耶, 超爽Der</p>

<p>你就順手的打開<code>cmd</code>, 輸入<code>npm update -g</code></p>

<p>然後<code>npm</code>跑了好一段時間來update&hellip;.</p>

<h2>接著..噩夢從此開始&hellip;</h2>

<p>你開心地覺得有更新版的可用真好</p>

<p>然後阿</p>

<p>你又在node.js找到一些想要用的module, OK</p>

<p>馬上來玩玩看! 使用 <code>npm install 巴拉巴拉 -g</code></p>

<p>疑!? ERROR!?</p>

<p>蛤!!?!? 簡單的裝個npm install 套件, 居然會ERROR?!!?</p>

<p>大概類似出現底下這樣,</p>

<p><code>npm err windows_nt 6.1.7601</code></p>

<p>然後還有什麼&hellip;</p>

<p><code>Error: EXDEV, cross-device link not permitted</code></p>

<p>OK, 你開始找問題, 上網搜尋了一堆, 大家好像也都遇到奇怪的問題</p>

<p>然後還會亂給建議&hellip;</p>

<p>沒辦法! 真的沒頭緒, 只能一個個Try&hellip;</p>

<p>不管如何Try, 你會發現這個ERROR出現的太詭異了&hellip;</p>

<p>找啊找的.. 真的完全沒頭緒</p>

<p>你快瘋了&hellip;</p>

<h2>就這樣, 突然靈光一閃</h2>

<p>好的, 遇到一些奇怪的問題時, 真的沒辦法解, 你會想要怎麼做?</p>

<p>對, 使用<strong>Clean Room</strong>的環境!!!</p>

<p>先解釋什麼叫做<code>Clean Room</code>, <code>Clean Room</code>就是在乾淨的地方, 重新做一次實驗</p>

<p>我想到, 假如我安裝個模組就出現一堆ERROR, 那node.js release manager不就是要去吃&hellip;嗎!!</p>

<p>當然他不會吃&hellip;! 他一定會做好完整的測試才會Release對吧!?</p>

<p>OK, 所以呢, 接下來, 我執行了</p>

<ol>
<li><code>npm cache clean -f</code> (npm還會跳出一個警告視窗說: 你確定你知道你要做的是什麼對吧?)</li>
<li><code>npm install -g</code> (重裝一次)</li>
</ol>


<p>好的, 沒用!</p>

<p><strong>Fuxxxxk!</strong></p>

<h2>突然間, 又靈光一閃</h2>

<p><code>npm cache clean</code> 真的有完全清除嗎!?</p>

<p>我就到了<code>C:\Users\KennyTu\AppData\Roaming</code>目錄下的<code>npm-cache</code>去看, 執行完clean之後, 這個目錄的東西完全沒動到阿!</p>

<p>為什麼我會知道要去這個<code>C:\Users\KennyTu\AppData\Roaming</code>目錄呢, 你就執行</p>

<p><code>npm config get prefix</code>, npm就會return它把安裝的東西放到哪邊去了</p>

<p>哈哈哈哈~~~</p>

<p>好的, 最後我怎麼做呢?</p>

<h2>最終解法</h2>

<p>不囉嗦, 照著底下做</p>

<ol>
<li>從windows的新增移除程式, 移除node.js以及相關的套件(如果有的話)</li>
<li>到<code>C:\Users\KennyTu\AppData\Roaming</code>把<code>npm-cache</code>以及<code>npm</code>這兩個目錄幹掉!</li>
<li>重開機</li>
<li>重新從<a href="https://nodejs.org/en/">nodejs.org</a> 下載Windows的安裝包, 安裝一次</li>
<li>大功告成!</li>
</ol>


<p>對, 就是這樣</p>

<p>為什麼會有這樣的問題呢!?</p>

<p>起因就是在於, 新版和舊版的npm對於路徑的設定不同, 然後又不向下相容, 所以就會導致新的npm要去找某個路徑, 發現他找不到!?</p>

<p>舉個例子, 新版npm在安裝沒有安裝過的模組的時候, 需要 <code>超機車的耶</code> 這個套件, 然後npm發現cache裡面已經有 <code>超機車的耶</code> 這個套件, 但是這個 <code>超機車的耶</code> 這個套件是舊的npm裝的, 有些路徑設定在新版的npm沒有, 然後呢, 新版的npm就很高興的去 <code>超機車的耶</code> 這個cache裡面找他要的一些資訊&hellip;. 欸!!? 沒有找到!? 怎麼可能!!? 幹! 報錯給使用者了啦! 老子不爽裝了啦!!!</p>

<p>好的, 就是這樣, 這也是為什麼我們要把前朝的npm所遺留下來的cache清掉的原因&hellip;.</p>

<h2>提醒Windows用戶的注意事項</h2>

<p>所以呢, 總結一下經驗法則</p>

<ol>
<li><strong>他X的千萬不要在console中, 使用npm update -g</strong>, 你會死掉</li>
<li><strong>如果你不小心手癢了! 請照上述的最終解法重來一遍吧</strong></li>
</ol>


<p>OK, 附帶一提</p>

<h3>新版sails的問題</h3>

<p>當你把npm修好之後, 使用<code>npm install -g sails</code> 安裝成功</p>

<p>使用<code>sails new testProj</code></p>

<p>then <code>cd testProj</code></p>

<p>Run <code>sails lift</code></p>

<p>你會發現幹~ 怎麼不能RUN, 報錯呢!!! 靠杯</p>

<p>好的, 自力自強, 看error log, 是說找不到什麼洨的套件</p>

<p>就安裝他吧! 例如他靠杯說少了<code>基八毛</code>套件</p>

<p>那就是<code>npm install -g 基八毛</code></p>

<p>裝到Global安裝目錄去!</p>

<p>接著看<code>sails lift</code> 報什麼洨 她找不到的, 就通通滿足她!</p>

<p>裝飽之後~</p>

<p><code>sails lift</code> 就可以正常執行啦!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之十五-Understanding Websockets and socket.io]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/08/sails-study15/"/>
    <updated>2015-12-08T13:56:14+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/08/sails-study15</id>
    <content type="html"><![CDATA[<p>影片是: <a href="https://www.youtube.com/watch?v=dkf3XKrsqAM" target="_blank">Understanding websockets and socket.io</a></p>

<p>Irl介紹了一下Socket.io, 並且寫了一個範例程式, 內容滿精彩的, 非常值得看的一篇教學</p>

<p>在範例的程式碼當中, 分成Server Side以及Client Side的網頁</p>

<p>Server Side是用node.js寫一個小型的http server,然後掛上socket.io的module,用來處理前端的要求</p>

<p>Client Side則是一個簡單的index.html,掛上JQuery的Javascript以及Socket.io的Javascript</p>

<p>socket.io很適合用來做聊天程式,Irl示範了如何開啟兩個(或以上)的獨立聊天室並且講解觀念</p>

<p>他的範例有一些小bug, 修改一下就可以run了, 首先我們從Server Side開始</p>

<!--more-->


<p><code>mkdir initial_test</code></p>

<p><code>cd initial_test</code></p>

<p><code>npm init</code></p>

<p><code>npm install socket.io --save</code></p>

<p><code>touch app.js</code></p>

<p>上面的說明就是</p>

<ol>
<li>新增一個initial_test的資料夾</li>
<li>進入資料夾</li>
<li>使用npm init創建一個初始的package.json</li>
<li>使用npm安裝socket.io, 用&ndash;save將相依性寫入package.json,注意安裝socket.io的時候可能需要visual studio 2012的C++ compiler, 若沒有裝Visual Studio 2012的朋友要先去安裝一下</li>
<li>創建一個app.js, 就可以開始編寫內容了</li>
</ol>


<p>另外package.json裡面的main target要記得改成app.js, 這樣就可以了</p>

<p>底下是完成的app.js程式碼</p>

<figure class='code'><figcaption><span>app.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">).</span><span class="nx">createServer</span><span class="p">(</span><span class="nx">handler</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">io</span>  <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;socket.io&#39;</span><span class="p">).</span><span class="nx">listen</span><span class="p">(</span><span class="nx">app</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3333</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">handler</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">fs</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="nx">__dirname</span> <span class="o">+</span> <span class="s1">&#39;/index.html&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">data</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="s1">&#39;Error loading index.html&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">writeHead</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">end</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">socket</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">socket</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="s1">&#39;Welcome to chat!&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;send message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>       <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;new message&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;send message2&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>        <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="k">in</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span><span class="p">).</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;new message&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;subscribe&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>        <span class="nx">socket</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">room</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">room</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//In a new version of socket.io (1.x),</span>
</span><span class='line'>        <span class="c1">//io.sockets.manager.rooms will cause an error.</span>
</span><span class='line'>        <span class="c1">//You should use io.sockets.adapter.rooms instead.</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;There are the room:&quot;</span><span class="p">,</span> <span class="nx">io</span><span class="p">.</span><span class="nx">sockets</span><span class="p">.</span><span class="nx">adapter</span><span class="p">.</span><span class="nx">rooms</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>ok, 以上是app.js, 注意到, 在<code>socket.io 1.x</code>版本以後, <strong>已經沒有<code>io.sockets.manager</code>這個屬性</strong>了, 要<strong>改用<code>io.sockets.adapter</code></strong></p>

<p>app.js撰寫完之後, 在相同目錄下, 執行<code>node app.js</code>, Server端就預備好了!</p>

<p>接下來是Client端</p>

<figure class='code'><figcaption><span>index.html</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;title&gt;&lt;/title&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;style </span><span class="na">type=</span><span class="s">&quot;text/css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nf">#incoming-chat-window</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">height</span><span class="o">:</span> <span class="m">300px</span><span class="p">;</span>
</span><span class='line'>            <span class="k">overflow</span><span class="o">:</span> <span class="k">auto</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="nt">&lt;/style&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!-- Chat Form to All sockets --&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;incoming-chat-window&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;outgoing-chat-form&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;input</span> <span class="na">size=</span><span class="s">&quot;50&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;outgoing-chat-field&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
</span><span class='line'>    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
</span><span class='line'><span class="nt">&lt;/form&gt;</span>
</span><span class='line'><span class="c">&lt;!-- END--&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!-- Chat Form to Beta Room--&gt;</span>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">&quot;incoming-chat-window2&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">&quot;outgoing-chat-form2&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;input</span> <span class="na">size=</span><span class="s">&quot;50&quot;</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">id=</span><span class="s">&quot;outgoing-chat-field2&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
</span><span class='line'>    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span><span class="nt">&gt;&lt;/input&gt;</span>
</span><span class='line'><span class="nt">&lt;/form&gt;</span>
</span><span class='line'><span class="c">&lt;!-- END--&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!-- Join &#39;beta&#39; room --&gt;</span>
</span><span class='line'><span class="nt">&lt;button</span> <span class="na">id=</span><span class="s">&quot;room&quot;</span><span class="nt">&gt;</span>Join Room<span class="nt">&lt;/button&gt;</span>
</span><span class='line'><span class="c">&lt;!-- END --&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;/socket.io/socket.io.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;script&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//Default Room</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#outgoing-chat-form&#39;</span><span class="p">).</span><span class="nx">submit</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>            <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;send message&#39;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#outgoing-chat-field&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
</span><span class='line'>            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#outgoing-chat-field&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//Beta Room</span>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#outgoing-chat-form2&#39;</span><span class="p">).</span><span class="nx">submit</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>            <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;send message2&#39;</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#outgoing-chat-field2&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">());</span>
</span><span class='line'>            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#outgoing-chat-field2&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">socket</span> <span class="o">=</span> <span class="nx">io</span><span class="p">(</span><span class="s1">&#39;http://localhost:3333&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;news&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#incoming-chat-window&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">data</span> <span class="o">+</span> <span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="c1">//socket.emit(&#39;my other event&#39;, { my: &#39;data&#39; });</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">socket</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;new message&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#incoming-chat-window&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">data</span> <span class="o">+</span> <span class="s1">&#39;&lt;br/&gt;&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">$</span><span class="p">(</span><span class="s1">&#39; #room&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">room</span><span class="o">:</span> <span class="s1">&#39;beta&#39;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="nx">socket</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;subscribe&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>這支網頁用到了Socket.io, JQuery兩個外部引用</p>

<p>特別是<code>&lt;script src="http://kennytu.github.io/socket.io/socket.io.js"&gt;&lt;/script&gt;</code></p>

<p>若有想要知道node.js的Server如何知道要從node_modules的哪一個地方取得socket.io.js給Client, 請參考這個網頁 <a href="http://stackoverflow.com/questions/10860244/how-to-make-the-require-in-node-js-to-be-always-relative-to-the-root-folder-of-t" target="_blank">How to make the require in node.js to be always relative to the root folder of the project?</a></p>

<p>簡短來說, 若再node.js裡面使用require敘述句, 例如<code>var io  = require('socket.io').listen(app);</code> 那麼node.js就會去node_modules裡面找socket.io資料夾, 並且把裡面的模組都import進來,</p>

<p>你可以在<code>node_modules\socket.io</code>找到一個<code>index.js</code>, 裡面就只有一個敘述句<code>module.exports = require('./lib');</code></p>

<p>然後你又可以在<code>node_modules\socket.io\lib</code>裡面找到<code>index.js</code>, 裡面包含一個<code>var client = require('socket.io-client');</code>, 這個敘述句就是node.js會去node_modules裡面去找socket.io-client的模組, 也把她import進來</p>

<p>大概是這樣的流程</p>

<p>好的, 回到<code>index.html</code></p>

<p>使用<code>node app.js</code>這個指令啟動http server之後, 我們開啟瀏覽器</p>

<p>輸入<code>localhost:3333</code> 取得網頁, 就可以看到畫面</p>

<p>然後可以玩玩看兩個聊天室, 一個是Default的, 另一個是Beta, 需要按下<code>join Room</code>這個Button才能進去.</p>

<p>剩下的說明請看Irl先生的精采教學吧!!!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之十四 - Hacker: 修改前端程式碼立馬變成Admin]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/07/sails-study14/"/>
    <updated>2015-12-07T13:51:19+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/07/sails-study14</id>
    <content type="html"><![CDATA[<p>在之前的章節, Ira展示了如何區分管理者和一般使用者. 然而有些網友, 指出了一些漏洞, 讓我們可以直接修改前端程式碼, 就可以獲得管理者的權限.</p>

<p>影片在這邊: <a href="https://www.youtube.com/watch?v=TgiK34eDGOU" target="_blank">Building a Sails Application: Ep17a - Marshalling request parameters</a></p>

<p>好的, 主要的概念是這樣, 開啟瀏覽器, 使用一般使用者登入, 進入修改頁面(Edit), 然後用firefox的firebug開啟除錯模式, 將admin的checkbox加進去html裡面, 並且將checkbox勾選起來, 最後按下proceed!</p>

<p>你就會發現, 一般使用者突然間就會變成管理員嚕! 超High的!</p>

<!--more-->


<p>問題的發生點是在UserController.js的<code>update</code> action</p>

<p>我們在update的時候, 呼叫底下這一行</p>

<figure class='code'><figcaption><span>UserController.js的update</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'> <span class="nx">User</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">all</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">userUpdated</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中第二個參數是取用所有來自req的參數, 所以這就讓我們可以使用insert admin的技巧來奪取管理員權限了</p>

<p>所以我們修改如下</p>

<figure class='code'><figcaption><span>UserController.js update</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">update</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">admin</span> <span class="o">!=</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">values</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nb">Array</span><span class="p">){</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">admin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;on&#39;</span><span class="p">){</span>
</span><span class='line'>                <span class="nx">values</span><span class="p">.</span><span class="nx">admin</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">userObj</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
</span><span class='line'>            <span class="nx">title</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
</span><span class='line'>            <span class="nx">email</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">admin</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">userObj</span><span class="p">.</span><span class="nx">admin</span> <span class="o">=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">admin</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//replace req.params.all with userObj</span>
</span><span class='line'>        <span class="nx">User</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="nx">userObj</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">userUpdated</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/edit/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/show/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, 主要是我們去檢查這個Session的使用者是否一剛開始的Session就是Admin, 是的話我們才去設定Admin的屬性</p>

<p>除了Edit頁面, 我們要在Create的頁面也要設下檢查條件</p>

<figure class='code'><figcaption><span>UserController.js create action</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">create</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">userObj</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">name</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
</span><span class='line'>            <span class="nx">title</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;title&#39;</span><span class="p">),</span>
</span><span class='line'>            <span class="nx">email</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">),</span>
</span><span class='line'>            <span class="nx">password</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">),</span>
</span><span class='line'>            <span class="nx">confirmation</span><span class="o">:</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;confirmation&#39;</span><span class="p">)</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//replce req.params.all with userObj</span>
</span><span class='line'>        <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">userObj</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">userCreated</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//if(err) return next(err);</span>
</span><span class='line'>          <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>存檔, 重新啟動sails, 大功告成啦~</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之十三 - 區分管理者和一般使用者]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/04/sails-study13/"/>
    <updated>2015-12-04T19:57:17+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/04/sails-study13</id>
    <content type="html"><![CDATA[<p>本篇的Video在<a href="https://www.youtube.com/watch?v=DI85AWW_TEk" target="_blank">Building a Sails Application: Ep17 - Creating a distinction between admin and regular users.</a></p>

<p>這一章我在實作的時候遇到了很多問題, 尤其是前端使用者的Edit頁面, 將Admin打勾傳送到後端, 卻發生admin始終都是false的狀況.</p>

<p>看了網路上不少文章, 我把我自己的解法以及網路上的解法還有參考網站都列在本篇文章中</p>

<p>OK, 讓我們開始.</p>

<p>在<code>activeityOverload\api\models\User.js</code>新增<code>admin</code>的<code>attribute</code></p>

<!--more-->




<figure class='code'><figcaption><span>User.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">attributes</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">name</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">title</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">email</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">admin</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
</span><span class='line'>            <span class="nx">defaultsTo</span><span class="o">:</span> <span class="kc">false</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">encryptedPassword</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span>
</span><span class='line'>        <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toObject</span><span class="p">();</span>
</span><span class='line'>            <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
</span><span class='line'>            <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">confirmation</span><span class="p">;</span>
</span><span class='line'>            <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">encryptedPassword</span><span class="p">;</span>
</span><span class='line'>            <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_csrf</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意到admin的defaultsTo是false, 你可以先設定為True, 然後執行sails先新增一個使用者, 讓他預設有admin的權限, 之後再改回來false.</p>

<p>接著到<code>SessionController.js</code>, 在<code>create</code>action中加入底下幾行</p>

<figure class='code'><figcaption><span>SessionController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// If the user is also an admin redirect to the user list (e.g. /views/user/index.ejs)</span>
</span><span class='line'><span class="c1">// This is used in conjunction with config/policies.js file</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//Redirect to their profile page (e.g. /views/user/show.ejs)</span>
</span><span class='line'><span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/show/&#39;</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>然後, 在<code>activeityOverload\api\policies\</code>目錄下新增一個<code>admin.js</code>的policies, 內容如下</p>

<figure class='code'><figcaption><span>admin.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Allow any authenticated user.</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// User is allowed, proceed to controller</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">User</span> <span class="o">&amp;&amp;</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">ok</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// User is not allowed</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">requireAdminError</span> <span class="o">=</span> <span class="p">[{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;requireAdminError&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;You must be an admin.&#39;</span><span class="p">}]</span>
</span><span class='line'>        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">err</span><span class="o">:</span> <span class="nx">requireAdminError</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/session/new&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>接著, 開啟<code>activeityOverload\config\policies.js</code>, 新增底下</p>

<figure class='code'><figcaption><span>config\policies.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="s1">&#39;flash&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">user</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;new&#39;</span><span class="o">:</span> <span class="s2">&quot;flash&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;create&#39;</span><span class="o">:</span> <span class="s2">&quot;flash&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="s2">&quot;admin&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, 存檔, 從新啟動sails, 看看登入畫面. 登入的時候出現你需要是admin的權限才能進入, 這不是我們想要的</p>

<p>所以我們回頭再修改policy,</p>

<p>我們要在<code>activeityOverload\api\policies\</code>再新增一個<code>userCanSeeProfile.js</code>的Policy, 內容如下</p>

<figure class='code'><figcaption><span>userCanSeeProfile.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Allow a logged-in user to see, edit and update her own profile</span>
</span><span class='line'><span class="cm"> * Allow admins to see everyone</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">sessionUserMatchesId</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">id</span> <span class="o">===</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">isAdmin</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">admin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// The requested id does not match the user&#39;s id,</span>
</span><span class='line'>    <span class="c1">// and this is not an admin</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">sessionUserMatchesId</span> <span class="o">||</span> <span class="nx">isAdmin</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">noRightsError</span> <span class="o">=</span> <span class="p">[{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;noRights&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;You must be an admin.&#39;</span><span class="p">}]</span>
</span><span class='line'>        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">err</span><span class="o">:</span> <span class="nx">noRightsError</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/session/new&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">ok</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>回頭修改<code>activeityOverload\config\policies.js</code></p>

<figure class='code'><figcaption><span>config\policies.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="s1">&#39;flash&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">user</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;new&#39;</span><span class="o">:</span> <span class="s2">&quot;flash&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;create&#39;</span><span class="o">:</span> <span class="s2">&quot;flash&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;show&#39;</span><span class="o">:</span> <span class="s2">&quot;userCanSeeProfile&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">edit</span><span class="o">:</span>   <span class="s2">&quot;userCanSeeProfile&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">update</span><span class="o">:</span> <span class="s2">&quot;userCanSeeProfile&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="s2">&quot;admin&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>存檔, 從新啟動sails, 應該就可以正常登入了</p>

<p>正常登陸之後, 我們會發現就算不是Admin的使用者也是可以看到頭導航欄的<code>User Administration</code>的按鈕, 我們想要修改一下</p>

<p>到layout.ejs,</p>

<figure class='code'><figcaption><span>layout.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="err">/head&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;navbar navbar-inverse navbar-fixed-top&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;container&quot;</span><span class="o">&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;navbar-header&quot;</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;button&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;navbar-toggle&quot;</span> <span class="nx">data</span><span class="o">-</span><span class="nx">toggle</span><span class="o">=</span><span class="s2">&quot;collapse&quot;</span> <span class="nx">data</span><span class="o">-</span><span class="nx">target</span><span class="o">=</span><span class="s2">&quot;.navbar-collapse&quot;</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;icon-bar&quot;</span><span class="o">&gt;&lt;</span><span class="err">/span&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;icon-bar&quot;</span><span class="o">&gt;&lt;</span><span class="err">/span&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">span</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;icon-bar&quot;</span><span class="o">&gt;&lt;</span><span class="err">/span&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/button&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">a</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;navbar-brand&quot;</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/&quot;</span><span class="o">&gt;</span> <span class="nx">activityOverlord</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;navbar-collapse collapse&quot;</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">ul</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;nav navbar-nav&quot;</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">li</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;active&quot;</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user/show/&lt;%= session.User.id %&gt;&quot;</span><span class="o">&gt;&lt;%=</span> <span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">name</span> <span class="o">%&gt;</span> <span class="o">&lt;</span><span class="err">/a&gt; &lt;/li&gt;</span>
</span><span class='line'>                <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span><span class='line'>                <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span> <span class="o">&amp;&amp;</span> <span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user&quot;</span><span class="o">&gt;</span><span class="nx">User</span> <span class="nx">Administration</span><span class="o">&lt;</span><span class="err">/a&gt;&lt;/li&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;#&quot;</span><span class="o">&gt;</span><span class="nx">Placeholder2</span><span class="o">&lt;</span><span class="err">/a&gt;&lt;/li&gt;</span>
</span><span class='line'>                <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/ul&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;navbar-right&quot;</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">a</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-default navbar-btn navbar-right&quot;</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/session/destroy&quot;</span><span class="o">&gt;</span><span class="nx">sign</span><span class="o">-</span><span class="nx">out</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span><span class='line'>                <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>            <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="nx">form</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;navbar-form navbar-right&quot;</span> <span class="nx">action</span><span class="o">=</span><span class="s2">&quot;/session/create&quot;</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-group&quot;</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;Email&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;email&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-group&quot;</span><span class="o">&gt;</span>
</span><span class='line'>                    <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;Password&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span><span class="o">&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">button</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-success&quot;</span><span class="o">&gt;</span><span class="nx">Sign</span> <span class="k">in</span><span class="o">&lt;</span><span class="err">/button&gt;</span>
</span><span class='line'>                <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;_csrf&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= _csrf %&gt;&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'>            <span class="o">&lt;</span><span class="err">/form&gt;</span>
</span><span class='line'>            <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span><span class='line'>        <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;%-</span> <span class="nx">body</span> <span class="o">%&gt;</span>
</span><span class='line'>
</span><span class='line'> <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, 存檔, 從新啟動Sails, 就可以了.</p>

<p>好, 接下來, 我們要讓<code>http://localhost:1337/user</code>顯示的頁面有可愛的圖示來區分使用者是Admin還是Regular.</p>

<p>開啟<code>activeityOverload\views\user\index.ejs</code>, 新增以下程式碼</p>

<figure class='code'><figcaption><span>views\user\index.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">...</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">title</span> <span class="o">%&gt;&lt;</span><span class="err">/td&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">%&gt;&lt;</span><span class="err">/td&gt;</span>
</span><span class='line'><span class="o">&lt;%</span> <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span> <span class="o">%</span> <span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;/images/admin.png&quot;</span><span class="o">&gt;&lt;</span><span class="err">/td&gt;</span>
</span><span class='line'><span class="o">&lt;%</span><span class="p">}</span> <span class="k">else</span>  <span class="p">{</span> <span class="o">%</span> <span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;/images/pawn.png&quot;</span><span class="o">&gt;&lt;</span><span class="err">/td&gt;</span>
</span><span class='line'><span class="o">&lt;%</span><span class="p">}</span><span class="o">%&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user/show/&lt;%= user.id %&gt;&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-sm btn-primary&quot;</span><span class="o">&gt;</span><span class="nx">Show</span><span class="o">&lt;</span><span class="err">/a&gt;&lt;/td&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>另外我們在<code>activeityOverload\views\user\show.ejs</code>也加入可愛的圖示</p>

<figure class='code'><figcaption><span>show.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;container&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">%&gt;&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="k">if</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;/images/admin.png&quot;</span><span class="o">&gt;</span> <span class="nx">admin</span>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">img</span> <span class="nx">src</span><span class="o">=</span><span class="s2">&quot;/images/pawn.png&quot;</span><span class="o">&gt;</span> <span class="nx">pawm</span>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">title</span> <span class="o">%&gt;&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">hr</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">contact</span><span class="o">:</span> <span class="o">&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">%&gt;&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">a</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-medium btn-primary&quot;</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user/edit/&lt;%= user.id %&gt;&quot;</span><span class="o">&gt;</span><span class="nx">Edit</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, 接下來要進入本章需要修改的部分, 和本Video的程式碼不同</p>

<p>我們要修改edit.ejs, 讓edit的頁面有admin的check box可供使用者勾選</p>

<figure class='code'><figcaption><span>activeityOverload\views\user\edit.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">form</span> <span class="nx">action</span><span class="o">=</span><span class="s2">&quot;/user/update/&lt;%= user.id %&gt;&quot;</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-signin&quot;</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span> <span class="nx">Hey</span><span class="p">,</span> <span class="nx">you</span><span class="err">&#39;</span><span class="nx">re</span> <span class="nx">editing</span> <span class="nx">a</span> <span class="nx">user</span><span class="p">...</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= user.name %&gt;&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;name&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= user.title %&gt;&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;title&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= user.email %&gt;&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;email&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span> <span class="o">&amp;&amp;</span> <span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>      <span class="o">&lt;%</span> <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;checkAdmin&quot;</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="nx">label</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;checkbox&quot;</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;checkbox&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span> <span class="nx">checked</span><span class="o">&gt;</span> <span class="nx">Admin</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="err">/label&gt;</span>
</span><span class='line'>      <span class="o">&lt;%</span> <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;checkAdmin&quot;</span><span class="o">&gt;</span>
</span><span class='line'>          <span class="o">&lt;</span><span class="nx">label</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;checkbox&quot;</span><span class="o">&gt;&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;checkbox&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span><span class="o">&gt;</span> <span class="nx">Admin</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span><span class='line'>      <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;Proceed&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-lg btn-primary btn-block&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;_csrf&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= _csrf %&gt;&quot;</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>在這邊, 作者把 input type=hidden的name取名為admin, 而input type=checkbox的name也叫做admin</p>

<p>這會有個效果出現, 若使用者<strong>沒有勾選</strong><code>checkbox</code>的話, 則這個form所丟出的update action, <code>admin</code>會是一個<strong>只有名叫<code>checkAdmin</code>的字串物件</strong>.</p>

<p>但若使用者<strong>有勾選checkbox</strong>的話, 則這個<code>admin</code>會是一個<code>Array</code>, 第一個是admin的value名稱(也就是checkAdmin), 第二個是checkbox的狀態<strong>&lsquo;on&rsquo;</strong>的字串.</p>

<h2>User.js的beforeValidation 改變</h2>

<p>接著作者回來修改User.js, 他在程式碼中加入了beforeValidation的function,
這個是sails在對action動作的其中一個life cycle.</p>

<p>在新版本的Sails (我目前的Version為0.11.2), 已經沒有beforeValidation的function了. 名稱修改為<code>beforeValidate</code>, 其他的life cycle, 請參考官方網頁 <a href="http://sailsjs.org/documentation/concepts/models-and-orm/lifecycle-callbacks" target="_blank">Lifecycle callbacks</a></p>

<p>在這邊, 作者在程式碼中加入了<code>beforeValidation</code>的function,先對<code>values.admin</code>做判斷, 理當<code>values.admin</code>所帶的值要不是<strong>checkAdmin</strong>的字串物件, 要不就是一個<strong>陣列</strong>(如前所述), 但我在這邊測試的結果, <strong>新版的sails, 在beforeValidate中, values.admin永遠都會是false</strong>!!</p>

<p>也就是說, 若我們要處理values.admin的這個值,若要確保是從網頁那邊過來的第一手原始資料的話, 我們必須從<code>activeityOverload\api\controllers\UserController.js</code>的<code>update</code>這個action就要開始處倆, 所以我將<code>User.js</code>的<code>beforeValidate</code>的判斷邏輯移到這邊(也就是將beforeValidate刪除), 底下是程式碼</p>

<figure class='code'><figcaption><span>api\controllers\UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'> <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">all</span><span class="p">());</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">values</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">allParams</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">admin</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">admin</span> <span class="o">!=</span> <span class="kc">undefined</span> <span class="o">&amp;&amp;</span> <span class="nx">values</span><span class="p">.</span><span class="nx">admin</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">===</span> <span class="nb">Array</span><span class="p">){</span>
</span><span class='line'>            <span class="k">if</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">admin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;on&#39;</span><span class="p">){</span>
</span><span class='line'>                <span class="nx">values</span><span class="p">.</span><span class="nx">admin</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, 修改到這邊, 功能大概都完成了, 存檔, 重新啟動sails</p>

<p>就可以玩玩看admin user以及一般regular user的功能了!</p>

<h2>補充:關於Create第一個Admin User</h2>

<p>除了上面講的, 在設定User.js的admin attribute的時候, 將defaultsTo: 設定為true, 新增一個admin使用者再改回false之外</p>

<p>還可以使用mongo-express, 進入資料庫, 然後修改user的檔案, 將admin: false 設定為true就可以了. 相當簡單</p>

<p>若沒有admin這個attribute, 就直接在資料庫當中新增一個admin: true, 就可以了!</p>

<h2>補充:關於beforeValidate的更正與修改</h2>

<p>一些相關的討論請參考<a href="http://irlnathan.github.io/sailscasts/blog/2013/09/05/building-a-sails-application-ep17-creating-a-distinction-between-admin-and-regular-users/" target="_blank">Building a Sails Application: Ep17 </a></p>

<p>其中有個網友他將解法寫在edit.js, 不用到後端去判斷, 方法如下</p>

<ol>
<li>emove the &lsquo;beforeValidation&rsquo; method from /api/models/User.js</li>
<li>add in /views/user/edit.ejs 以下的程式碼</li>
</ol>


<figure class='code'><figcaption><span>edit.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;%</span> <span class="k">if</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span> <span class="o">&amp;&amp;</span> <span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">id</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;admin&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&amp;lt;% user.admin ? &#39;true&#39; : &#39;false&#39; %&amp;gt;&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">label</span><span class="o">&gt;&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;checkbox&quot;</span> <span class="o">&lt;%=</span><span class="s2">&quot;&quot;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">admin</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="o">?=</span><span class="s2">&quot;&quot;</span> <span class="s1">&#39;checked&#39;</span><span class="o">:</span><span class="s1">&#39;&#39;</span><span class="o">=</span><span class="s2">&quot;&quot;</span> <span class="o">%=</span><span class="s2">&quot;&quot;</span><span class="o">&gt;</span> <span class="nx">onClick</span><span class="o">=</span><span class="s2">&quot;document.getElementById(&#39;admin&#39;).value = this.checked;&quot;</span><span class="o">&gt;</span> <span class="nx">Admin</span><span class="o">&lt;</span><span class="err">/label&gt;</span>
</span><span class='line'><span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>大致上就是說, 在前端的ejs就先將admin判斷好, 並且把admin設成true or false, 這樣就可以了.</p>

<h2>參考資料</h2>

<p><a href="http://stackoverflow.com/questions/767486/how-do-you-check-if-a-variable-is-an-array-in-javascript" target="_blank">How do you check if a variable is an array in JavaScript?</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之十二 - 改善User登入認證的導航介面]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/04/sails-study12/"/>
    <updated>2015-12-04T14:34:16+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/04/sails-study12</id>
    <content type="html"><![CDATA[<p>本章主要是調整登入的外觀</p>

<p>課程連結是 <a href="https://www.youtube.com/watch?v=P0K36-c5G4A" target="_blank">Building a Sails Application: Ep15 - Improving user authenticated navigation.</a></p>

<p>主要是修改<code>activeityOverload\views\layout.ejs</code></p>

<p>在原本<code>&lt;%- body %&gt;</code>的上方, 有個簡單的頭導航介面, 把它換成如下的程式碼</p>

<!--more-->




<figure class='code'><figcaption><span>layout.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>...
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;body&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-inverse navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-header&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;button&quot;</span> <span class="na">class=</span><span class="s">&quot;navbar-toggle&quot;</span> <span class="na">data-toggle=</span><span class="s">&quot;collapse&quot;</span> <span class="na">data-target=</span><span class="s">&quot;.navbar-collapse&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;icon-bar&quot;</span><span class="nt">&gt;&lt;/span&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/button&gt;</span>
</span><span class='line'>        <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;navbar-brand&quot;</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span> activityOverlord<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-collapse collapse&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;ul</span> <span class="na">class=</span><span class="s">&quot;nav navbar-nav&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="err">&lt;</span>% if (session.authenticated) { %&gt;
</span><span class='line'>            <span class="nt">&lt;li</span> <span class="na">class=</span><span class="s">&quot;active&quot;</span><span class="nt">&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/user/show/&lt;%= session.User.id %&gt;&quot;</span><span class="nt">&gt;</span><span class="err">&lt;</span>%= session.User.name %&gt; <span class="nt">&lt;/a&gt;</span> <span class="nt">&lt;/li&gt;</span>
</span><span class='line'>            <span class="err">&lt;</span>% } %&gt;
</span><span class='line'>            <span class="err">&lt;</span>% if (session.authenticated <span class="err">&amp;&amp;</span> session.User.admin) { %&gt;
</span><span class='line'>            <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/user&quot;</span><span class="nt">&gt;</span>User Administration<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class='line'>            <span class="nt">&lt;li&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span><span class="nt">&gt;</span>Placeholder2<span class="nt">&lt;/a&gt;&lt;/li&gt;</span>
</span><span class='line'>            <span class="err">&lt;</span>% } %&gt;
</span><span class='line'>        <span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar-right&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="err">&lt;</span>% if (session.authenticated) { %&gt;
</span><span class='line'>            <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;btn btn-default navbar-btn navbar-right&quot;</span> <span class="na">href=</span><span class="s">&quot;/session/destroy&quot;</span><span class="nt">&gt;</span>sign-out<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>            <span class="err">&lt;</span>% } %&gt;
</span><span class='line'>        <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>        <span class="err">&lt;</span>% if (!session.authenticated) { %&gt;
</span><span class='line'>        <span class="nt">&lt;form</span> <span class="na">class=</span><span class="s">&quot;navbar-form navbar-right&quot;</span> <span class="na">action=</span><span class="s">&quot;/session/create&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-group&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;Email&quot;</span> <span class="na">name=</span><span class="s">&quot;email&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>            <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;form-group&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>                <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;Password&quot;</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>            <span class="nt">&lt;button</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-success&quot;</span><span class="nt">&gt;</span>Sign in<span class="nt">&lt;/button&gt;</span>
</span><span class='line'>            <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value=</span><span class="s">&quot;&lt;%= _csrf %&gt;&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/form&gt;</span>
</span><span class='line'>        <span class="err">&lt;</span>% } %&gt;
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">&lt;</span>%- body %&gt;
</span><span class='line'>...
</span></code></pre></td></tr></table></div></figure>


<p>也可以參考作者的<a href="https://github.com/irlnathan/activityoverlord/blob/master/views/layout.ejs" target="_blank">GitHub</a>, 直接把程式碼copy過來貼到你現在的專案就可以了</p>

<p>存檔之後, 重新啟動sails, 就可以看到修改過精美的導航介面了</p>

<p>至於解說的部分, 請看作者在影片中的講解嚕!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Node.js更新問題]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/03/nodejs-update/"/>
    <updated>2015-12-03T19:31:51+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/03/nodejs-update</id>
    <content type="html"><![CDATA[<p>在更新<code>node.js</code>以及<code>npm</code>之後 (npm現在被包在node.js裡面一起安裝)</p>

<p>我執行npm -g update, global有更新的node.js的module都update到最新的</p>

<p>接著我切換到我這一陣子再用的sails的專案, 執行sails lift的時候</p>

<p>發生了<code>Cannot find module 'lru-cache'</code> 這個事件</p>

<!--more-->


<p>解決的方法是, 執行以下的指令</p>

<pre><code>rm -rf node_modules
npm cache clean
npm install
</code></pre>

<p>先將sails專案裡面的node_modules刪除, 然後清空Cache, 接著重新安裝一次, 這樣Sails就可以正常運行了</p>

<p>另外, 在執行sails lift的時候, 若sails的資料庫有綁定mongo db, 但你還沒有啟動mondo db時, 會出現以下訊息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='batch'><span class='line'>error: A hook (<span class="sb">`orm`</span>) failed to load!
</span><span class='line'>E:\sails_app\activeityOverload\node_modules\mongodb\lib\server.js:235
</span><span class='line'>        process.nextTick(function() { throw err; })
</span><span class='line'>                                      ^
</span><span class='line'>
</span><span class='line'>TypeError: Cannot read property <span class="s1">&#39;close&#39;</span> of undefined
</span><span class='line'>    at E:\sails_app\activeityOverload\node_modules\sails-mongo\lib\adapter.js:138<span class="nl">:13</span>
</span><span class='line'>    at E:\sails_app\activeityOverload\node_modules\sails-mongo\node_modules\async\lib\async.js:187<span class="nl">:20</span>
</span><span class='line'>    at E:\sails_app\activeityOverload\node_modules\sails-mongo\node_modules\async\lib\async.js:239<span class="nl">:13</span>
</span><span class='line'>    at _arrayEach (E:\sails_app\activeityOverload\node_modules\sails-mongo\node_modules\async\lib\async.js:91<span class="nl">:13</span>)
</span><span class='line'>    at _each (E:\sails_app\activeityOverload\node_modules\sails-mongo\node_modules\async\lib\async.js:82<span class="nl">:13</span>)
</span></code></pre></td></tr></table></div></figure>


<p>這就表示sails 掛不到 mongo db, 只要先啟動mongo db, 然後再啟動sails lift就沒問題了!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之十一 - 使用者認證以及嚴格存取]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/03/sails-study11/"/>
    <updated>2015-12-03T18:16:13+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/03/sails-study11</id>
    <content type="html"><![CDATA[<p>本章的Video為 <a href="https://www.youtube.com/watch?v=AooPVuYGnuU" target="_blank">Ep14 - User authentication and restricting access through policies.</a></p>

<p>首先,我們要先將前一章的Session的練習的程式碼先拿掉,</p>

<p>接著修改<code>SessionController.js</code>, 新增<code>create action</code></p>

<!--more-->




<figure class='code'><figcaption><span>SessionController.js新增Create action</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">var</span> <span class="nx">bcrypt</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcrypt&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;new&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;session/new&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Check for email and password in params sent via the form, if none</span>
</span><span class='line'>        <span class="c1">// redirect the browser back to the sign-in form.</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">// return next({err: [&quot;Password doesn&#39;t match password confirmation.&quot;]});</span>
</span><span class='line'>
</span><span class='line'>            <span class="kd">var</span> <span class="nx">usernamePasswordRequiredError</span> <span class="o">=</span> <span class="p">[{</span>
</span><span class='line'>                <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;usernamePasswordRequired&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;You must enter both a username and password.&#39;</span>
</span><span class='line'>            <span class="p">}]</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Remember that err is the object being passed down (a.k.a. flash.err), whose value is another object with</span>
</span><span class='line'>            <span class="c1">// the key of usernamePasswordRequiredError</span>
</span><span class='line'>            <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">err</span><span class="o">:</span> <span class="nx">usernamePasswordRequiredError</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/session/new&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Try to find the user by there email address.</span>
</span><span class='line'>        <span class="c1">// findOneByEmail() is a dynamic finder in that it searches the model by a particular attribute.</span>
</span><span class='line'>        <span class="c1">// User.findOneByEmail(req.param(&#39;email&#39;)).done(function(err, user) {</span>
</span><span class='line'>        <span class="nx">User</span><span class="p">.</span><span class="nx">findOneByEmail</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="nx">foundUser</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// If no user is found...</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="kd">var</span> <span class="nx">noAccountError</span> <span class="o">=</span> <span class="p">[{</span>
</span><span class='line'>                    <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;noAccount&#39;</span><span class="p">,</span>
</span><span class='line'>                    <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;The email address &#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; not found.&#39;</span>
</span><span class='line'>                <span class="p">}]</span>
</span><span class='line'>                <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">err</span><span class="o">:</span> <span class="nx">noAccountError</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/session/new&#39;</span><span class="p">);</span>
</span><span class='line'>                <span class="k">return</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Compare password from the form params to the encrypted password of the user found.</span>
</span><span class='line'>            <span class="nx">bcrypt</span><span class="p">.</span><span class="nx">compare</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;password&#39;</span><span class="p">),</span> <span class="nx">user</span><span class="p">.</span><span class="nx">encryptedPassword</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">valid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// If the password from the form doesn&#39;t match the password from the database...</span>
</span><span class='line'>                <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">valid</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="kd">var</span> <span class="nx">usernamePasswordMismatchError</span> <span class="o">=</span> <span class="p">[{</span>
</span><span class='line'>                        <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;usernamePasswordMismatch&#39;</span><span class="p">,</span>
</span><span class='line'>                        <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Invalid username and password combination.&#39;</span>
</span><span class='line'>                    <span class="p">}]</span>
</span><span class='line'>                    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nx">err</span><span class="o">:</span> <span class="nx">usernamePasswordMismatchError</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>                    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/session/new&#39;</span><span class="p">);</span>
</span><span class='line'>                    <span class="k">return</span><span class="p">;</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// Log user in</span>
</span><span class='line'>                <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">User</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>                <span class="c1">// Change status to online</span>
</span><span class='line'>                <span class="nx">user</span><span class="p">.</span><span class="nx">online</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>                <span class="nx">user</span><span class="p">.</span><span class="nx">save</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c1">// Inform other sockets (e.g. connected sockets that are subscribed) that this user is now logged in</span>
</span><span class='line'>                    <span class="nx">User</span><span class="p">.</span><span class="nx">publishUpdate</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nx">loggedIn</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>                        <span class="nx">id</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span>
</span><span class='line'>                        <span class="nx">name</span><span class="o">:</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
</span><span class='line'>                        <span class="nx">action</span><span class="o">:</span> <span class="s1">&#39; has logged in.&#39;</span>
</span><span class='line'>                    <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c1">// If the user is also an admin redirect to the user list (e.g. /views/user/index.ejs)</span>
</span><span class='line'>                    <span class="c1">// This is used in conjunction with config/policies.js file</span>
</span><span class='line'>                    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">.</span><span class="nx">admin</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">);</span>
</span><span class='line'>                        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>                    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>                    <span class="c1">//Redirect to their profile page (e.g. /views/user/show.ejs)</span>
</span><span class='line'>                    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/show/&#39;</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>                <span class="p">});</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>新增完成之後, 重新啟動sails, (<strong>記得啟動sails之前要先啟動Mongo DB</strong>), 然後試試看功能</p>

<p>到瀏覽器輸入<code>http://localhost:1337/session/new</code></p>

<p>然後輸入不正確的帳號密碼以及正確的帳號密碼試試看, 應該就沒問題了</p>

<p>另外, 關於Create的每一個判斷式, 就請參考Irl nathan本人的講解嚕</p>

<p>接著我們要在SessionController.js中加入destroy, 也就是Sign Out的Action</p>

<figure class='code'><figcaption><span>SessionController.js 新增Destroy action</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Wipe out the session (log out)</span>
</span><span class='line'>    <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Redirect the browser to the sign-in screen</span>
</span><span class='line'>    <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/session/new&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>把上面的程式碼加到Create Action之後, 然後重啟sails,</p>

<p>再登入之後, 直接輸入<code>http://localhost:1337/session/destroy</code> 就會跳回到登入頁面</p>

<p>不過我們可以發現, 就算登出了, 使用者還是可以直接輸入網址, 去瀏覽使用者,</p>

<p>例如在瀏覽器中輸入<code>http://localhost:1337/user</code> 一樣可以看到管理介面</p>

<p>所以我們要修改一些權限, 來達成管控的要求</p>

<p>先到<code>activeityOverload\api\policies\</code>底下新增<code>authenticated.js</code>, 程式碼如下</p>

<figure class='code'><figcaption><span>authenticated.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// User is allowed, proceed to controller</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">ok</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="p">{</span>  <span class="c1">// User is not allowed</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">requireLoginError</span> <span class="o">=</span> <span class="p">[{</span><span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;requireLogin&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;You must be signed in.&#39;</span><span class="p">}]</span>
</span><span class='line'>        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">err</span><span class="o">:</span> <span class="nx">requireLoginError</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/session/new&#39;</span><span class="p">);</span>
</span><span class='line'>        <span class="k">return</span><span class="p">;</span>
</span><span class='line'>        <span class="c1">//res.send(403);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>然後到<code>activeityOverload\config\</code>底下的<code>policies.js</code></p>

<p>新增以下的規則</p>

<figure class='code'><figcaption><span>policies.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'> <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="s1">&#39;flash&#39;</span><span class="p">,</span>
</span><span class='line'> <span class="nx">user</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;new&#39;</span><span class="o">:</span> <span class="s2">&quot;flash&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="s2">&quot;authenticated&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>解釋一下上面的Policies, 第一列的 * 表示 不管哪一個Controller都要經過flash規則</p>

<p>而第二列的是說, 針對user controller, 底下的new action我們套用flash, 而其他的action則套用authenticated這個規則.</p>

<p>所以只要是user底下的非new的action, 都要經過authenticated這個關卡. 大致上是這樣</p>

<p>新增完成之後. 重新啟動sails, 看看若我們直接輸入localcost:1337/user/, 若我們之前沒有登入, 則在authenticated.js中, req.session.User就會是空的, 因為是空, 所以是 null, 那麼邏輯就會走到else, 有就是User is not allowd的這判斷式中.</p>

<p>以上, 就是我們這一堂課的概要嚕, 但還沒結束, 作者在這一集<a href="https://www.youtube.com/watch?v=-wF07sqGmW0" target="_blank">Building a Sails Application: Ep16 - Fixing an issue with policies in episode 14</a></p>

<p>找到了一個要在本章修正的錯誤, 當我們在<code>config\policies.js</code>新增了filter rule之後, 會發現新增使用者之後, 到了create action, 也會套用到authenticated rule, 導致錯誤發生, 所以我們修正如下</p>

<figure class='code'><figcaption><span>config\policies.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="s1">&#39;flash&#39;</span><span class="p">,</span>
</span><span class='line'><span class="nx">user</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;new&#39;</span><span class="o">:</span> <span class="s2">&quot;flash&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;create&#39;</span><span class="o">:</span> <span class="s2">&quot;flash&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="s2">&quot;authenticated&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>在user controller新增一個create action套用flash的rule即可</p>

<p>另外到<code>UserController.js</code>, 在<code>create</code>的action中新加入兩段codes</p>

<figure class='code'><figcaption><span>UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'> <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">all</span><span class="p">(),</span> <span class="kd">function</span> <span class="nx">userCreated</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="c1">//if(err) return next(err);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>                <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>                    <span class="nx">err</span><span class="o">:</span> <span class="nx">err</span>
</span><span class='line'>                <span class="p">}</span>
</span><span class='line'>                <span class="c1">//if error redirect back to sign-up page</span>
</span><span class='line'>                <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/new&#39;</span><span class="p">);</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">//res.json(user);</span>
</span><span class='line'>            <span class="c1">//req.session.flash = {};</span>
</span><span class='line'>          <span class="c1">//新增底下這兩段code</span>
</span><span class='line'>            <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">User</span> <span class="o">=</span> <span class="nx">user</span><span class="p">;</span>
</span><span class='line'>            <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/show/&#39;</span> <span class="o">+</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK. 這樣應該就沒問題了</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之十 - Session]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/02/sails-study10/"/>
    <updated>2015-12-02T17:07:35+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/02/sails-study10</id>
    <content type="html"><![CDATA[<p>本篇進展到這邊, 主要是提到Session的使用, 影片是<a href="https://www.youtube.com/watch?v=SY2AcAHxIiU" target="_blank">Building a Sails Application: Ep13 - Sign-in page, session controller, new action, and sessions.</a></p>

<p>首先, 在<code>views/</code>新增一個目錄名叫<code>session</code>, 在<code>session</code>裡面新增一個ejs檔案名為<code>new.ejs</code></p>

<figure class='code'><figcaption><span>activeityOverload\views\session\new.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">form</span> <span class="nx">action</span><span class="o">=</span><span class="s2">&quot;/session/create&quot;</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-signin&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h2</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-signin-heading&quot;</span><span class="o">&gt;</span><span class="nx">Please</span> <span class="nx">sign</span> <span class="k">in</span><span class="p">...</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="k">if</span><span class="p">(</span><span class="nx">flash</span> <span class="o">&amp;&amp;</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">ul</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;alert alert-success&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">flash</span><span class="p">.</span><span class="nx">err</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span> <span class="o">%&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;&lt;%-</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">flash</span><span class="p">.</span><span class="nx">err</span><span class="p">[</span><span class="nx">error</span><span class="p">])</span> <span class="o">%&gt;&lt;</span><span class="err">/li&gt;</span>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="p">})</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/ul&gt;</span>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="p">}</span> <span class="o">%&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;Email address&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;email&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;Password&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-lg btn-primary btn-block&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;Sign-in&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;_csrf&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= _csrf %&gt;&quot;</span> <span class="o">/&gt;</span>
</span><span class='line'>  
</span><span class='line'><span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<p>存檔之後, 到專案目錄底下開啟command line tool, 然後輸入<code>sails generate controller session</code></p>

<p>接著sails就會產生<code>activeityOverload\api\controllers\SessionController.js</code>這個檔案</p>

<p>我們到<code>SessionController.js</code>新增程式碼</p>

<figure class='code'><figcaption><span>SessionController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;new&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">oldDataObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">newDateObj</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(</span><span class="nx">oldDataObj</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="mi">60000</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">expires</span> <span class="o">=</span> <span class="nx">newDateObj</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">(</span><span class="s1">&#39;session/new&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>然後到<code>activeityOverload\api\controllers\UserController.js</code></p>

<p>在<code>index</code>的<code>action</code>新增兩行Debug message, 如下</p>

<figure class='code'><figcaption><span>UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">index</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">());</span>
</span><span class='line'>        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">authenticated</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">//Get an array of all users in the User collection(e.g. table)</span>
</span><span class='line'>        <span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span> <span class="nx">foundUsers</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">users</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>            <span class="c1">//pass the array down to the /views/index.ejs page</span>
</span><span class='line'>            <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">({</span>
</span><span class='line'>                <span class="nx">users</span><span class="o">:</span> <span class="nx">users</span>
</span><span class='line'>            <span class="p">});</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>    <span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>新增完成之後, 我們重新啟動sails,</p>

<p>先在瀏覽器中輸入<code>http://localhost:1337/session/new</code></p>

<p>然後在sails的console畫面中可以看到以下畫面</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">Session</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">cookie</span><span class="o">:</span>
</span><span class='line'>   <span class="p">{</span> <span class="nx">path</span><span class="o">:</span> <span class="s1">&#39;/&#39;</span><span class="p">,</span>
</span><span class='line'>     <span class="nx">_expires</span><span class="o">:</span> <span class="nx">Wed</span> <span class="nx">Dec</span> <span class="mi">02</span> <span class="mi">2015</span> <span class="mi">17</span><span class="o">:</span><span class="mi">31</span><span class="o">:</span><span class="mi">50</span> <span class="nx">GMT</span><span class="o">+</span><span class="mi">0800</span> <span class="p">(</span><span class="err">台北標準時間</span><span class="p">),</span>
</span><span class='line'>     <span class="nx">originalMaxAge</span><span class="o">:</span> <span class="mi">60000</span><span class="p">,</span>
</span><span class='line'>     <span class="nx">httpOnly</span><span class="o">:</span> <span class="kc">true</span> <span class="p">},</span>
</span><span class='line'>  <span class="nx">csrfSecret</span><span class="o">:</span> <span class="s1">&#39;paEKhxeTpDC5hQqu_ns64Ufi&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">authenticated</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我們觀察到authenticated還是為true</p>

<p>接著, 我們要來觀察<code>req.session.cookie.expires</code>設定之後的結果, 我們是設定成60秒,</p>

<p>開啟瀏覽器, 輸入<code>http://localhost:1337/user</code>,然後觀察後台的輸出</p>

<p>會像是這樣</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='batch'><span class='line'>Wed Dec <span class="m">02</span> <span class="m">2015</span> <span class="m">17</span><span class="nl">:31:04</span> GMT+<span class="m">0800</span> (台北標準時間)
</span><span class='line'>true
</span><span class='line'>Wed Dec <span class="m">02</span> <span class="m">2015</span> <span class="m">17</span><span class="nl">:31:34</span> GMT+<span class="m">0800</span> (台北標準時間)
</span><span class='line'>true
</span><span class='line'>Wed Dec <span class="m">02</span> <span class="m">2015</span> <span class="m">17</span><span class="nl">:31:39</span> GMT+<span class="m">0800</span> (台北標準時間)
</span><span class='line'>true
</span><span class='line'>Wed Dec <span class="m">02</span> <span class="m">2015</span> <span class="m">17</span><span class="nl">:31:59</span> GMT+<span class="m">0800</span> (台北標準時間)
</span><span class='line'>undefined  &lt;- <span class="m">60</span>秒之後<span class="p">,</span> authenticated會變為undefined!
</span></code></pre></td></tr></table></div></figure>


<p>以上就是session的實驗囉!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之九-加密]]></title>
    <link href="http://kennytu.github.io/blog/2015/12/01/sails-study09/"/>
    <updated>2015-12-01T17:39:08+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/12/01/sails-study09</id>
    <content type="html"><![CDATA[<p>OK, 上課的影片是: <a href="https://www.youtube.com/watch?v=1wziI6l0NyE" target="_blank">Building a Sails Application: Ep11 - Encrypting passwords with bcrypt.</a></p>

<p>到<a href="https://www.npmjs.com/package/bcrypt" target="_blank">Bcrypt</a>看一下相關的資訊</p>

<p>安裝的步驟如下</p>

<p>到專案目錄, 執行<code>npm install bcrypt --save</code></p>

<p>加上<code>--save</code>的意思是除了install bcrypt到專案底下之外, 也把相依性設定寫入package.json, 這樣以後如果有人想要直接使用這個專案, 在目錄底下輸入npm install, 就可以將此專案需要用到的packages一次設定完成!</p>

<p>另外安裝<code>bcrypt</code>需要Visual Studio 2013的支援, 若你的Visual Studio版本大於2013, 請在安裝的時候再加入<code>--msvs_version=2013</code></p>

<p>也就是<code>npm install bcrypt --save --msvs_version=2013</code></p>

<!--more-->


<p>OK, 安裝順利的話, 會出現如下的訊息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='batch'><span class='line'>E:\sails_app\activeityOverload<span class="p">&gt;</span><span class="n">npm</span> install bcrypt --save
</span><span class='line'>-
</span><span class='line'><span class="p">&gt;</span> <span class="n">bcrypt</span>@<span class="m">0</span>.<span class="m">8</span>.<span class="m">5</span> install E:\sails_app\activeityOverload\node_modules\bcrypt
</span><span class='line'><span class="p">&gt;</span> <span class="n">node</span>-gyp rebuild
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>E:\sails_app\activeityOverload\node_modules\bcrypt<span class="p">&gt;</span><span class="n">if</span> not <span class="k">defined</span> npm_config_node_gyp (node <span class="s2">&quot;C:\Program Files\nodejs\node_modules\npm\bin\node-gyp-bin\\..\..\node_modules\node-gyp\bin\node-gyp.js&quot;</span> rebuild )  <span class="k">else</span> (node  rebuild )
</span><span class='line'>
</span><span class='line'>在這個方案中一次建置一個專案。若要啟用平行組建，請加入 <span class="s2">&quot;/m&quot;</span> 參數。 (Visual Studio <span class="m">2013</span> C++ Support)
</span><span class='line'>  blowfish.cc
</span><span class='line'>  bcrypt.cc
</span><span class='line'>..\src\bcrypt.cc(<span class="m">232</span>): warning C<span class="m">4267</span>: <span class="s1">&#39;=&#39;</span> : conversion from <span class="s1">&#39;size_t&#39;</span> to <span class="s1">&#39;unsigned char&#39;</span><span class="p">,</span> possible loss of data
</span><span class='line'>[E:\sails_app\activeityOverload\node_modules\bcrypt\build\bcrypt_lib.vcxproj]  bcrypt_node.cc ..\src\bcrypt_node.cc(<span class="m">76</span>): warning C<span class="m">4244</span>: <span class="s1">&#39;argument&#39;</span> : conversion from <span class="s1">&#39;ssize_t&#39;</span> to <span class="s1">&#39;unsigned char&#39;</span><span class="p">,</span> possible loss  of data
</span><span class='line'>
</span><span class='line'>[E:\sails_app\activeityOverload\node_modules\bcrypt\build\bcrypt_lib.vcxproj]
</span><span class='line'>..\src\bcrypt_node.cc(<span class="m">135</span>): warning C<span class="m">4244</span>: <span class="s1">&#39;argument&#39;</span> : conversion from <span class="s1">&#39;const ssize_t&#39;</span> to <span class="s1">&#39;unsigned char&#39;</span><span class="p">,</span> possible loss of data
</span><span class='line'>
</span><span class='line'>[E:\sails_app\activeityOverload\node_modules\bcrypt\build\bcrypt_lib.vcxproj]
</span><span class='line'>..\src\bcrypt_node.cc(<span class="m">229</span>): warning C<span class="m">4267</span>: <span class="s1">&#39;initializing&#39;</span> : conversion from <span class="s1">&#39;size_t&#39;</span> to <span class="s1">&#39;int&#39;</span><span class="p">,</span> possible loss of data
</span><span class='line'>
</span><span class='line'>[E:\sails_app\activeityOverload\node_modules\bcrypt\build\bcrypt_lib.vcxproj]
</span><span class='line'>..\src\bcrypt_node.cc(<span class="m">230</span>): warning C<span class="m">4267</span>: <span class="s1">&#39;initializing&#39;</span> : conversion from <span class="s1">&#39;size_t&#39;</span> to <span class="s1">&#39;int&#39;</span><span class="p">,</span> possible loss of data
</span><span class='line'>
</span><span class='line'>[E:\sails_app\activeityOverload\node_modules\bcrypt\build\bcrypt_lib.vcxproj]
</span><span class='line'>win_delay_load_hook.c
</span><span class='line'>
</span><span class='line'>Creating library E:\sails_app\activeityOverload\node_modules\bcrypt\build\Release\bcrypt_lib.lib and
</span><span class='line'>object E:\sails_app\activeityOverload\node_modules\bcrypt\build\Release\bcrypt_lib.exp
</span><span class='line'>  Generating code
</span><span class='line'>  Finished generating code
</span><span class='line'>  bcrypt_lib.vcxproj -<span class="p">&gt;</span> <span class="n">E</span>:\sails_app\activeityOverload\node_modules\bcrypt\build\Release\\bcrypt_lib.node
</span><span class='line'>
</span><span class='line'>bcrypt@<span class="m">0</span>.<span class="m">8</span>.<span class="m">5</span> node_modules\bcrypt
</span><span class='line'>├── bindings@<span class="m">1</span>.<span class="m">2</span>.<span class="m">1</span>
</span><span class='line'>└── nan@<span class="m">2</span>.<span class="m">0</span>.<span class="m">5</span>
</span></code></pre></td></tr></table></div></figure>


<p>裝完之後, 接著我們修改<code>activeityOverload\api\models\</code>底下的<code>User.js</code></p>

<figure class='code'><figcaption><span>User.js 新增beforeCreate Function</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">schema</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">attributes</span><span class="o">:</span> <span class="p">{...},</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">beforeCreate</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// This checks to make sure the password and password confirmation match before creating record</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">values</span><span class="p">.</span><span class="nx">password</span> <span class="o">||</span> <span class="nx">values</span><span class="p">.</span><span class="nx">password</span> <span class="o">!=</span> <span class="nx">values</span><span class="p">.</span><span class="nx">confirmation</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">next</span><span class="p">({</span><span class="nx">err</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;Password doesn&#39;t match password confirmation.&quot;</span><span class="p">]});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;bcrypt&#39;</span><span class="p">).</span><span class="nx">hash</span><span class="p">(</span><span class="nx">values</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">passwordEncrypted</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">encryptedPassword</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>      <span class="nx">values</span><span class="p">.</span><span class="nx">encryptedPassword</span> <span class="o">=</span> <span class="nx">encryptedPassword</span><span class="p">;</span>
</span><span class='line'>      <span class="c1">// values.online= true;</span>
</span><span class='line'>      <span class="nx">next</span><span class="p">();</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>新增完成之後, 重啟sails, (啟動sails之前記得要先啟動mongo db)</p>

<p>接著新增一名使用者看看, 新增完成之後, 使用<code>mongo-express</code>登入進去mongo db的後台去看, 我們的新的使用者是不是有已經加密過的密碼了!</p>

<p>好的, 大致上是這樣嚕</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mongo Database 簡介以及GUI介面使用]]></title>
    <link href="http://kennytu.github.io/blog/2015/11/27/mongodb-setting/"/>
    <updated>2015-11-27T19:25:17+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/11/27/mongodb-setting</id>
    <content type="html"><![CDATA[<p>在進行sails練習的下一章之前, 有需要對Mongo Database做一些簡單的練習.</p>

<p>由於我看到Irl nathan是使用<a href="http://genghisapp.com/" target="_blank">Genghis</a>來作為Mongo DB的Web GUI介面, 但是是在MAC OS上安裝的, 我想在Win7上面也來裝一下, 以方便連接Mongo DB, 但天殺的在win7上安裝遇到太多問題, 甚至還要修改C語言的程式碼&hellip;.</p>

<p>我review了一下genghis, 發現這個作者在2014年年底就沒有再維護了&hellip;</p>

<p>奮戰了三到四個小時之後, 我更改戰略, 到mongodb的官網看看還有沒有其他更適合的WEB ADMIN GUI可以用</p>

<p>所以我改用了<a href="https://github.com/andzdroid/mongo-express" target="_blank">mongo-express</a></p>

<p>這篇文章就是在介紹mongo-express怎麼使用(最基本的)</p>

<!--more-->


<p>若要看看其他Mongo database的其他延伸應用, 請參考<a href="https://docs.mongodb.org/ecosystem/tools/administration-interfaces/" target="_blank">MongoDB Integration and Tools > Admin UIs</a></p>

<p>說實在的我之前都是用SQL的, 對於NOSQL還真的沒啥概念.</p>

<p>底下開始介紹Mongo Database</p>

<h2>我的版本</h2>

<p>npm版本 <code>2.14.4</code>, 使用<code>npm -v</code> 取得</p>

<p>node版本 <code>v4.1.1</code>, 使用<code>node -v</code> 取得</p>

<p>mongod版本:</p>

<pre><code>db version v3.0.7
git version: 6ce7cbe8c6b899552dadd907604559806aa2e9bd
</code></pre>

<p>使用 <code>mongod.exe --version</code> 取得</p>

<p>mongo-express版本 <code>0.27.3</code>, 使用<code>npm list mongo-express -g</code> 取得</p>

<p><strong>其實MongoDB的版本2.4, 版本2.6以及3.x版本的改動很大&hellip; 也沒有向下相容, 所以在學習上頗有曲線</strong></p>

<h2>安裝Mongo Database</h2>

<p>基礎的安裝我描述在<strong>Sails練習之八-連結資料庫</strong>, 可以參考. 基本上我是安裝到<code>global</code></p>

<h2>Mongo Database基本指令</h2>

<h3>Server端常用指令</h3>

<p><code>mongod.exe -d user_path_for_db</code></p>

<h3>Client端常用指令</h3>

<p>在MongoDB的安裝路徑下的bin目錄, 輸入<code>mongo.exe</code>, 進入互動CMD介面</p>

<p><code>db</code> : 列出現在使用的database</p>

<p><code>show dbs</code> : 列出所有的databases</p>

<p><code>show users</code> :  列出所有的用戶</p>

<p><code>use [database]</code> : 使用use切換到指定的database, ex: <code>use test</code></p>

<h2>Server Side</h2>

<p>啟動伺服器端, 在 <code>MongoDB\bin</code>目錄下執行<code>mongod.exe</code> 就可以了, 記得要定義預設的資料庫存放路徑, 例如<code>/data/db</code> (若Mongo DB的執行檔在<code>C槽</code>, 那就是<code>C:\data\db</code>, 若沒有定義預設存放路徑, 則需要指名存放資料庫的路徑, 例如<code>D:\MongoDB\bin&gt;mongod.exe --dbpath=D:\MongoDB\data</code></p>

<p>另外, 如果要讓Client連進來的時候需要Auth, 則在啟動mongo的時候, 在後面加入<code>--auth</code> 就可以了, 例如 <code>mongod.exe --auth</code></p>

<p>基本上為了方便起見, 我都<strong>先不加</strong><code>auth</code></p>

<p>請參考<a href="https://docs.mongodb.org/manual/tutorial/enable-authentication/" target="_blank">Enable Client Access Control</a></p>

<h2>新增使用者在MongoDB</h2>

<p>進入Mongo Client Tool, 然後輸入底下指令</p>

<pre><code>use admin
db.createUser({user:"root",pwd:"kenny888",roles:[]})
</code></pre>

<p>這樣就可以了, 詳細的官方網站步驟請到底下兩個網頁</p>

<ul>
<li><a href="https://docs.mongodb.org/manual/tutorial/enable-authentication/" target="_blank">Enable Client Access Control</a></li>
<li><a href="https://docs.mongodb.org/manual/tutorial/manage-users-and-roles/" target="_blank">Manage User and Roles</a></li>
</ul>


<p>參考以上兩個網頁的步驟照著做也可以.</p>

<p>好的, 這樣我們就已經有一個在Admin資料庫的使用者root了</p>

<p>接下來要來安裝<code>mongo-express</code>啦</p>

<h3>安裝mongo-express</h3>

<pre><code>npm install -g mongo-express
</code></pre>

<p>安裝的時候須注意, mongo-express在win7上面可能需要visual studio 2013的編譯器來編譯一些C程式碼, 若沒有安裝visual studio 2013, 請先安裝完成之後再回頭來install mongo-express</p>

<p>接著, 因為我們是把mongo-express安裝到global去, 我們要找到安裝路徑, 你可以使用<code>npm list -g</code>來找出安裝路徑(會show在第一行), 在我的電腦就是<code>C:\Users\KennyTu\AppData\Roaming\npm</code></p>

<p>好的, 接下來切換路徑到<code>C:\Users\KennyTu\AppData\Roaming\npm\node_modules\mongo-express</code></p>

<p><code>copy</code>一份<code>config.default.js</code>到<code>config.js</code></p>

<p>然後修改<code>config.js</code></p>

<figure class='code'><figcaption><span>config.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>   <span class="p">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">//leave username and password empty if no admin account exists</span>
</span><span class='line'>    <span class="nx">adminUsername</span><span class="o">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">adminPassword</span><span class="o">:</span> <span class="s1">&#39;kenny888&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="p">...</span>
</span><span class='line'>  <span class="nx">basicAuth</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">username</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ME_CONFIG_BASICAUTH_USERNAME</span> <span class="o">||</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">password</span><span class="o">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ME_CONFIG_BASICAUTH_PASSWORD</span> <span class="o">||</span> <span class="s1">&#39;kenny888&#39;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>其實這一份config.js我還有很多東西沒有搞懂, 但先這樣設定, 我們的mongo-express就可以run了</p>

<p>有時候設定錯誤, 執行mongo-express會直接跳出來給你看, 沒有任何錯誤訊息&hellip;滿無言的</p>

<p>好,設定完之後, 存檔, 我們直接打開CMD</p>

<p>輸入<code>mongo-express</code>, 若沒有問題, 它會shows出底下訊息,</p>

<pre><code>Mongo Express server listening on port 8081 at 0.0.0.0
Database connected!
Admin Database connected
</code></pre>

<blockquote><p>記得輸入mongo-express之前, 要先執行mongod (server), 這樣mongo-express才不會出錯</p></blockquote>

<p>大功告成啦</p>

<p>這時候打開瀏覽器, 輸入<code>localhost:8081</code> 應該就看得到Web版本的管理頁面了!!!</p>

<p>最後, 附上網路上找到的一些Mongo DB的觀念</p>

<h2>mongod 概念</h2>

<p>一個 mongod 服務可以有建立多個數據庫，每個數據庫可以有多張表，這裡的表名叫 collection，每個 collection 可以存放多個文檔 (document)，每個文檔都以 BSON(binary json) 的形式存放於硬盤中，因此可以存儲比較復雜的數據類型。它是以單文檔為單位存儲的，你可以任意給一個或一批文檔新增或刪除字段，而不會對其它文檔造成影響，這就是所謂的 schema-free，這也是文檔型數據庫最主要的優點。跟一般的 key-value 數據庫不一樣的是，它的 value 中存儲了結構信息，所以你又可以像關系型數據庫那樣對某些域進行讀寫、統計等操作。Mongo 最大的特點是他支持的查詢語言非常強大，其語法有點類似於面向對象的查詢語言，幾乎可以實現類似關系數據庫單表查詢的絕大部分功能，而且還支持對數據建立索引。Mongo 還可以解決海量數據的查詢效率，根據官方文檔，當數據量達到 50GB 以上數據時，Mongo 數據庫訪問速度是 MySQL10 倍以上。</p>

<h2>BSON</h2>

<p>BSON 是 Binary JSON 的簡稱，是一個 JSON 文檔對象的二進制編碼格式。BSON 同 JSON 一樣支持往其它文檔對象和數組中再插入文檔對象和數組，同時擴展了 JSON 的數據類型。如：BSON 有 Date 類型和 BinDate 類型。</p>

<p>BSON 被比作二進制的交換格式，如同 Protocol Buffers，但 BSON 比它更 「schema-less」，非常好的靈活性但空間佔用稍微大一點。</p>

<p>BSON 有以下三個特點：輕量級、跨平台、效率高</p>

<h2>命名空間</h2>

<p>MongoDB 存儲 BSON 對象到 collections, 這一系列的數據庫名和 collection 名被稱為一個命名空間。如同：java.util.List; 用來管理數據庫中的數據。</p>

<h2>索引</h2>

<p>mongodb 可以對某個字段建立索引，可以建立組合索引、唯一索引，也可以刪除索引，建立索引就意味著增加空間開銷。默認情況下每個表都會有一個唯一索引：<em>id，如果插入數據時沒有指定</em>id，服務會自動生成一個<em>id，為了充分利用已有索引，減少空間開銷，最好是自己指定一個 unique 的 key 為</em>id，通常用對象的 ID 比較合適，比如商品的 ID。</p>

<h2>參考資料</h2>

<p><a href="http://www.ithome.com.tw/news/92506" target="_blank">了解 NoSQL 不可不知的 5 項觀念</a></p>

<p><a href="http://www.neohope.com/2015/09/12/acid%E3%80%81base%E4%B8%8Ecap/" target="_blank">ACID、BASE 與 CAP</a></p>

<p><a href="https://en.wikipedia.org/wiki/List_of_column-oriented_DBMSes" target="_blank">List of column-oriented DBMSes</a></p>

<p><a href="https://zh.wikipedia.org/wiki/%E5%88%97%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93" target="_blank">Row-oriented DBMS</a></p>

<p><a href="https://en.wikipedia.org/wiki/Column-oriented_DBMS" target="_blank">Column-oriented DBMS</a></p>

<p><a href="http://cryto.net/~joepie91/blog/2015/07/19/why-you-should-never-ever-ever-use-mongodb/" target="_blank">Why you should never, ever, ever use MongoDB</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之八-連結資料庫]]></title>
    <link href="http://kennytu.github.io/blog/2015/11/26/sails-study08/"/>
    <updated>2015-11-26T17:56:17+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/11/26/sails-study08</id>
    <content type="html"><![CDATA[<p>各位客官, 終於到了要使用到資料庫的時機了</p>

<p>本章節, Irl nathan介紹了Mongo Db的使用, 以及如何新增Mongo Db到我們的sails專案.</p>

<p>不過因為我現在用的sails是0.11.x的版本, 而Irl兄是0.9.x之前的, 所以一些設定上面都有些不同</p>

<p>Irl老兄的影片連結在這:<a href="https://www.youtube.com/watch?v=G4-fm_h8z-0" target="_blank">Building a Sails Application: Ep10 - Changing databases to mongoDB with sails adapters.</a></p>

<p>我在這邊主要以新版的sails為主. 底下介紹安裝方法</p>

<!--more-->


<p>首先, 進去sails的專案, 例如在<code>E:\sails_app\activeityOverload&gt;</code> 輸入</p>

<p><code>npm install sails-mongo --save</code></p>

<p>接著<code>npm</code>會下載<code>mongo</code>的程式碼, 若在windows系統, 會預設使用<code>visual studio</code>的C++來compiler,</p>

<p>這邊要注意, sails-mongo在windows系統下, <strong>預設使用visual studio 2013的版本編譯, 若比2013的版本低, 會發生編譯錯誤. 而若版本比2013高, 則需要額外的輸入條件</strong>, 底下舉例</p>

<p>版本是visual studio 2013</p>

<p><code>npm install sails-mongo --save</code></p>

<p>版本若是<strong>大於</strong>visual studio 2013, 則需要輸入</p>

<p><code>npm install sails-mongo --save --msvs_version=2013</code></p>

<p>PS. 大於Visual Studio 2013的版本我還沒試過</p>

<p>若還有任何問題, 請在google輸入<code>node-gyp v8.h syntax error</code>這幾個關鍵字, 應該有些線索你可以嘗試看看</p>

<p>好的, 基本上只要注意到這些, 應該就沒問題, Mongo Db就順利裝上去了</p>

<p>接下來要設定Sails專案的Mongo Db的檔案</p>

<p>修改兩個檔案, 一個是<code>connection.js</code>,</p>

<figure class='code'><figcaption><span>config\connections.js 修改someMongodbServer</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'> <span class="cm">/***************************************************************************</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  * MongoDB is the leading NoSQL database.                                   *</span>
</span><span class='line'><span class="cm">  * http://en.wikipedia.org/wiki/MongoDB                                     *</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  * Run: npm install sails-mongo                                             *</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  ***************************************************************************/</span>
</span><span class='line'>  <span class="nx">someMongodbServer</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">adapter</span><span class="o">:</span> <span class="s1">&#39;sails-mongo&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">host</span><span class="o">:</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">port</span><span class="o">:</span> <span class="mi">27017</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">user</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">password</span><span class="o">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="nx">database</span><span class="o">:</span> <span class="s1">&#39;activityoverlord&#39;</span>
</span><span class='line'>  <span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>另一個是<code>models.js</code></p>

<figure class='code'><figcaption><span>config\models.js 修改connection</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">models</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/***************************************************************************</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  * Your app&#39;s default connection. i.e. the name of one of your app&#39;s        *</span>
</span><span class='line'><span class="cm">  * connections (see `config/connections.js`)                                *</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  ***************************************************************************/</span>
</span><span class='line'>  <span class="c1">// connection: &#39;localDiskDb&#39;,</span>
</span><span class='line'>  <span class="nx">connection</span><span class="o">:</span> <span class="s1">&#39;someMongodbServer&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">autoCreatedAt</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="nx">autoUpdatedAt</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>  <span class="cm">/***************************************************************************</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  * How and whether Sails will attempt to automatically rebuild the          *</span>
</span><span class='line'><span class="cm">  * tables/collections/etc. in your schema.                                  *</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  * See http://sailsjs.org/#!/documentation/concepts/ORM/model-settings.html  *</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  ***************************************************************************/</span>
</span><span class='line'>   <span class="nx">migrate</span><span class="o">:</span> <span class="s1">&#39;safe&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>設定好之後, 存檔.</p>

<p>最後我們來安裝Mongo DB, 因為Irl nathan是在Mac OS上面已經裝好, 直接執行就可以了, 我們要在Win7上面裝MongoDB.</p>

<p>開啟<code>cmd</code></p>

<p>輸入 <code>wmic os get caption</code> 確認 作業系統版本</p>

<p>輸入 <code>wmic os get osarchitecture</code> 確認是幾位元的作業系統</p>

<p>確定完之後,到<a href="https://www.mongodb.org/downloads" target="_blank">MongoDb</a>下載相對應的版本.</p>

<p>例如我的作業系統是<code>Win7 64bits</code>, 那就下載<code>Windows 64-bit 2008 R2+</code>.</p>

<p>下載完成, 安裝, 請選Custom, 將安裝路徑裝到<code>C:\MongoDB</code>底下,我是裝到<code>D:\MongoDB</code>,</p>

<p>因為MongoDB預設會裝到C:\Program Files&hellip;巴拉巴拉, 太長了, 往後輸入指令不方便, 所以就縮短裝到比較方便找的目錄.</p>

<p>裝完之後, 在MongoDB安裝的那個磁碟區, 例如我裝在D槽, 打開cmd, 輸入<code>md \data\db</code>, 這會在<code>D:\</code>產生<code>data\db</code>的資料夾, 而這個資料夾是<strong>MongoDB預設會存取的資料夾</strong>.</p>

<p>OK, 接下來使用<code>cmd</code>切換到<code>MongoDB</code>的安裝路徑底下的<code>bin</code>目錄,輸入<code>mongod.exe</code>, <code>MongoDb</code>就啟動啦!</p>

<p>PS: 若你沒有Create \data\db, 那麼你執行<code>mongod.exe</code>就會發生錯誤</p>

<p>若你想要指定其他的資料庫存取目錄, 請在輸入<code>mongod.exe</code>的同時, 加入<code>--dbpath</code>, 例如</p>

<p><code>D:\MongoDB\bin&gt;mongod.exe --dbpath=D:\MongoDB\data</code></p>

<p>這樣就可以了!</p>

<p>以上安裝MongoDb的教學, 可參考以下網站</p>

<p><a href="http://blog.gtwang.org/windows/windows-install-mongodb-database/" target="_blank">在 Windows 中安裝 MongoDB 資料庫</a></p>

<p><a href="http://fecbob.pixnet.net/blog/post/38494357-mongodb%E5%9C%A8windows%E4%B8%8B%E5%AE%89%E8%A3%9D%E9%85%8D%E7%BD%AE" target="_blank">MongoDB 在 Windows 下安裝配置</a></p>

<p><a href="http://www.runoob.com/mongodb/mongodb-window-install.html" target="_blank">window 平台安装 MongoDB</a></p>

<p>好, 啟動MongoDb之後, 我們就可以切回來Sails專案了</p>

<p>我們重啟Sails, 指令<code>sails lift</code></p>

<p>接下來我們在瀏覽器輸入<code>http://localhost:1337</code>, 新增使用者</p>

<p>成功之後, 你會發現使用者已經被新增到MongoDb裡面去了, 試一下其他功能如修改, 應該都能正常運作!</p>

<p>今天就上到這邊啦! 下課~~~</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之七]]></title>
    <link href="http://kennytu.github.io/blog/2015/11/26/sails-study07/"/>
    <updated>2015-11-26T10:34:50+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/11/26/sails-study07</id>
    <content type="html"><![CDATA[<p>本章緊接著前一篇, 我們要來實作Delete的功能</p>

<p>這篇參考此Youtube:<a href="https://www.youtube.com/watch?v=6sIrHPlJJQk" target="_blank">Building a Sails Application: Ep9 - Deleting a user account.</a></p>

<p>我們到<code>UserController.js</code>去新增我們的delete程式碼</p>

<figure class='code'><figcaption><span>UserController.js 新增 destroy function</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>  <span class="nx">destroy</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Hi, destroy&quot;</span><span class="p">);</span>
</span><span class='line'>    <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="nx">foundUser</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="s1">&#39;User doesn\&#39;t exist.&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">User</span><span class="p">.</span><span class="nx">destroy</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="nx">userDestroyed</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>




<!--more-->


<p>我們注意到<code>if(!user) return next('User doesn\'t exist.');</code></p>

<p>我們也把這一段敘述加到<code>edit action</code>裡面</p>

<figure class='code'><figcaption><span>UserController.js 修改 edit action</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;hi, edit!&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Find the user from the id passed in via params</span>
</span><span class='line'>    <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="nx">foundUser</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="s1">&#39;User doesn\&#39;t exist.&#39;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">user</span><span class="o">:</span> <span class="nx">user</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'><span class="p">},</span>
</span></code></pre></td></tr></table></div></figure>


<p>然後我們回到<code>views\user\index.ejs</code>, 加入以下程式碼</p>

<figure class='code'><figcaption><span>views\user\index.ejs 加入destroy (使用POST方法)</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;h3&gt;</span>Users<span class="nt">&lt;/h3&gt;</span>
</span><span class='line'>  <span class="nt">&lt;table</span> <span class="na">class=</span><span class="s">&quot;table&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>      <span class="nt">&lt;th&gt;</span>ID<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>      <span class="nt">&lt;th&gt;</span>Name<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>      <span class="nt">&lt;th&gt;</span>Title<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>      <span class="nt">&lt;th&gt;</span>Email<span class="nt">&lt;/th&gt;</span>
</span><span class='line'>      <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
</span><span class='line'>      <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
</span><span class='line'>      <span class="nt">&lt;th&gt;&lt;/th&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="err">&lt;</span>% _.each(users, function(user){ %&gt;
</span><span class='line'>    <span class="nt">&lt;tr</span> <span class="na">data-id=</span><span class="s">&quot;&lt;%= user.id %&gt;&quot;</span> <span class="na">data-model=</span><span class="s">&quot;user&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= user.id %&gt;<span class="nt">&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= user.name %&gt;<span class="nt">&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= user.title%&gt;<span class="nt">&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;</span><span class="err">&lt;</span>%= user.email%&gt;<span class="nt">&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/user/show/&lt;%= user.id %&gt;&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-sm btn-primary&quot;</span><span class="nt">&gt;</span>Show<span class="nt">&lt;/a&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="nt">&lt;td&gt;&lt;a</span> <span class="na">href=</span><span class="s">&quot;/user/edit/&lt;%= user.id %&gt;&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-sm btn-warning&quot;</span><span class="nt">&gt;</span>Edit<span class="nt">&lt;/a&gt;&lt;/td&gt;</span>
</span><span class='line'>
</span><span class='line'>      <span class="nt">&lt;td&gt;</span>
</span><span class='line'>        <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/user/destroy/&lt;%= user.id%&gt;&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;_method&quot;</span> <span class="na">value=</span><span class="s">&quot;delete&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-sm btn-danger&quot;</span> <span class="na">value=</span><span class="s">&quot;Delete&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>          <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value=</span><span class="s">&quot;&lt;%= _csrf %&gt;&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/form&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/td&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="err">&lt;</span>%}) %&gt;
</span><span class='line'>  <span class="nt">&lt;/table&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意到我們對<code>destroy</code>使用<code>POST</code>方法, 其他的<code>action</code>我們是用<code>GET</code>方法</p>

<p>由於我們的destroy是用另外一個form, 所以我們要在新增一個hidden的_csrf, 否則我們會沒有辦法access網頁</p>

<p>好, 完成之後, 存檔, 重啟sails</p>

<p>瀏覽器輸入<code>http://localhost:1337/user</code></p>

<p>就可以玩玩看delete的功能了!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之六]]></title>
    <link href="http://kennytu.github.io/blog/2015/11/24/sails-study06/"/>
    <updated>2015-11-24T22:12:51+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/11/24/sails-study06</id>
    <content type="html"><![CDATA[<p>本章接著<a href="https://www.youtube.com/watch?v=GHp1g7Z0Yo4" target=_blank>Building a Sails Application: Ep8 - Adding a user list, index, edit, and update action.</a></p>

<p>影片一開始, Irl nathan介紹了ejs中, <code>&lt;%- %&gt;</code>以及<code>&lt;%= %&gt;</code>有什麼不同</p>

<p>簡單來說</p>

<p> <code>&lt;%- %&gt;</code>有 <code>-</code> 這個記號的, 若被此tag包含起來的程式碼有java script, 那麼ejs就會去執行它, 這個是一個很常會讓人侵入的地方,</p>

<p>而<code>&lt;%= %&gt;</code>就不會對java script做解讀,ejs會直接跳過js, 直接輸出到頁面上</p>

<p>還有一個是<code>&lt;% %&gt;</code>, 沒有加任何符號的, 這個就是單純的ejs嵌入javascript程式碼用的.</p>

<!--more-->


<p>Irl nathan示範了如何在新增使用者的欄位, 注入java script程式碼, 讓其可以執行的例子</p>

<p>我們在新增使用者的頁面, 在第二個欄位, 輸入user title的這個,</p>

<p>輸入<code>&lt;script&gt; alert("I am a bad guy");&lt;/script&gt;</code></p>

<p>將其他輸入項輸入完成之後, 按下Enter, 跳轉到User Info頁面的時候</p>

<p>會跳出一個<code>I am a bad guy</code>的alert,</p>

<p>這很不好, 所以我們要來改寫程式碼</p>

<p>將所有<code>&lt;%-</code>都換成<code>&lt;%=</code></p>

<figure class='code'><figcaption><span>show.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;container&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">%&gt;&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">title</span> <span class="o">%&gt;&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">hr</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">contact</span><span class="o">:</span> <span class="o">&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">%&gt;&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">a</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-medium btn-primary&quot;</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user/edit/&lt;%= user.id %&gt;%&gt;&quot;</span><span class="o">&gt;</span><span class="nx">Edit</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>好的, 基礎原理介紹了一下之後, 我們要進入正題</p>

<p>我們要修改當我們在瀏覽器輸入<code>http://localhost:1337/user</code>的時候,</p>

<p>後端會回傳一個user model的json格式回來, 我們要來將這個json做成精美的網頁</p>

<p>先到<code>UserController.js</code></p>

<p>加入底下程式碼</p>

<figure class='code'><figcaption><span>UserController.js 加入index function</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//render the profile view (e.g. /views/show.ejs)</span>
</span><span class='line'>    <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="nx">foundUser</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">({</span>
</span><span class='line'>          <span class="nx">user</span><span class="o">:</span> <span class="nx">user</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">index</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;hi! there!&quot;</span><span class="p">);</span>
</span><span class='line'>      <span class="c1">//Get an array of all users in the User collection(e.g. table)</span>
</span><span class='line'>      <span class="nx">User</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="kd">function</span> <span class="nx">foundUsers</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">users</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="c1">//pass the array down to the /views/index.ejs page</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">({</span>
</span><span class='line'>          <span class="nx">users</span><span class="o">:</span> <span class="nx">users</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接著在<code>views\user\</code> 新增 <code>index.ejs</code></p>

<figure class='code'><figcaption><span>views\user\index.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;container&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">Users</span><span class="o">&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">table</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;table&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">tr</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="nx">ID</span><span class="o">&lt;</span><span class="err">/th&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="nx">Name</span><span class="o">&lt;</span><span class="err">/th&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="nx">Title</span><span class="o">&lt;</span><span class="err">/th&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">th</span><span class="o">&gt;</span><span class="nx">Email</span><span class="o">&lt;</span><span class="err">/th&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">th</span><span class="o">&gt;&lt;</span><span class="err">/th&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">th</span><span class="o">&gt;&lt;</span><span class="err">/th&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">th</span><span class="o">&gt;&lt;</span><span class="err">/th&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/tr&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">&lt;%</span> <span class="nx">_</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="nx">users</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">user</span><span class="p">){</span> <span class="o">%&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">tr</span> <span class="nx">data</span><span class="o">-</span><span class="nx">id</span><span class="o">=</span><span class="s2">&quot;&lt;%= user.id %&gt;&quot;</span> <span class="nx">data</span><span class="o">-</span><span class="nx">model</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">id</span> <span class="o">%&gt;&lt;</span><span class="err">/td&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">%&gt;&lt;</span><span class="err">/td&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">title</span><span class="o">%&gt;&lt;</span><span class="err">/td&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;%=</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span><span class="o">%&gt;&lt;</span><span class="err">/td&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user/show/&lt;%= user.id %&gt;&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-sm btn-primary&quot;</span><span class="o">&gt;</span><span class="nx">Show</span><span class="o">&lt;</span><span class="err">/a&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user/edit/&lt;%= user.id %&gt;&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-sm btn-warning&quot;</span><span class="o">&gt;</span><span class="nx">Edit</span><span class="o">&lt;</span><span class="err">/a&gt;&lt;/td&gt;</span>
</span><span class='line'>      <span class="o">&lt;</span><span class="nx">td</span><span class="o">&gt;&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user/destroy/&lt;%= user.id %&gt;&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-sm btn-danger&quot;</span><span class="o">&gt;</span><span class="nx">Delete</span><span class="o">&lt;</span><span class="err">/a&gt;&lt;/td&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="err">/tr&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="o">&lt;%</span><span class="p">})</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/table&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>新增完成之後, 剩下的就是Saisl框架會幫我們處理的事情</p>

<p>存檔之後, 重啟sails</p>

<p>輸入 <code>http://localhost:1337/user</code></p>

<p>就可以看到精美的User List列表啦!</p>

<p>接下來我們來處理<code>edit</code>以及<code>update</code>這兩個action</p>

<p>回到<code>UserController.js</code>,新增<code>edit</code>以及<code>update</code></p>

<figure class='code'><figcaption><span>Usercontroller.js add Edit & update</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//render the edit view (e.g. /views/edit.ejs)</span>
</span><span class='line'>  <span class="nx">edit</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//Find the user from the id passed in via params</span>
</span><span class='line'>    <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="nx">foundUser</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">({</span>
</span><span class='line'>        <span class="nx">user</span><span class="o">:</span> <span class="nx">user</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// process the info from edit view</span>
</span><span class='line'>  <span class="nx">update</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
</span><span class='line'>    <span class="nx">User</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">all</span><span class="p">(),</span> <span class="kd">function</span> <span class="nx">userUpdated</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
</span><span class='line'>      <span class="k">if</span> <span class="p">(</span><span class="nx">err</span><span class="p">){</span>
</span><span class='line'>        <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/edit/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/show/&#39;</span> <span class="o">+</span> <span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">));</span>
</span><span class='line'>    <span class="p">});</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接著在<code>views\user\</code>新增<code>edit.ejs</code></p>

<figure class='code'><figcaption><span>views\user\edit.ejs </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">form</span> <span class="nx">action</span><span class="o">=</span><span class="s2">&quot;/user/update/&lt;%= user.id %&gt;&quot;</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-signin&quot;</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h2</span><span class="o">&gt;</span> <span class="nx">Hey</span><span class="p">,</span> <span class="nx">you</span><span class="err">&#39;</span><span class="nx">re</span> <span class="nx">editing</span> <span class="nx">a</span> <span class="nx">user</span><span class="p">...</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= user.name%&gt;&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;name&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= user.title%&gt;&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;title&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= user.email%&gt;&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;email&quot;</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;Proceed&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-lg btn-primary btn-block&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;_csrf&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= _csrf %&gt;&quot;</span><span class="o">/&gt;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>重啟sails, 我們試試看Edit, 應該有畫面出來了</p>

<p>接下來嘗試輸入一下資料, 發現居然有jQuery的Validation出來作怪!!!</p>

<p>作者在這邊大叫了一聲!!!~~~ 阿!~~~</p>

<p>隨即馬上說這個超簡單可以解決, 讓我們繼續看下去</p>

<p>我們先到<code>assets\js\dependencies\customVaildate.js</code></p>

<p>將這行 <code>$('.form-signin').validate({</code> 修改成 <code>$('#sign-up-form').validate({</code></p>

<p>注意我們將<code>.form-signin</code>改成<code>#sign-up-form</code>, 一個點變成一個井號</p>

<p>這邊要提到<code>CSS</code>以及<code>Javascript</code>的Class以及ID的用法</p>

<p>對於CSS來說, 使用<code>.</code>定義的都是Class, 而使用<code>#</code>的則是ID命名</p>

<p>關於Class以及ID的觀念和用法, 請參考底下網站</p>

<p><a href="http://www.minwt.com/webdesign-dev/css/30.html" target="_blank">[CSS]id 與 class 別再傻傻分不清楚</a></p>

<p><a href="http://www.1keydata.com/css-tutorial/tw/class-id.php" target="_blank"> CSS Class 與 CSS ID</a></p>

<p><a href="http://www.1keydata.com/css-tutorial/tw/syntax.php" target="_blank">CSS 教學 > 語法</a></p>

<p>所以呢, 我們作者就把jQuery這一段改成<code>id</code>之後, 就可以唯一指定登錄頁面是使用這個邏輯了</p>

<p>接著, 我們要去改views\user\new.ejs</p>

<figure class='code'><figcaption><span>new.ejs 新增id的屬性</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/user/create&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">id=</span><span class="s">&quot;sign-up-form&quot;</span> <span class="na">class=</span><span class="s">&quot;form-signin&quot;</span><span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>存檔之後, 重啟sails, 就可以在測試看看, JQuery的Vaildation就不會出現在Edit的頁面上了</p>

<blockquote><p>更新-> 我剛剛把edit.js裡面的action打成actoin,結果debug半天阿~ 拎老師咧</p></blockquote>

<p>好的, Edit功能做完之後, 測試完若沒有問題&hellip; 我們接下來就來處理Delete了</p>

<p>由於Delete會學習到POST的概念, 所以作者把它放在下一個課程</p>

<p>今天就先到這邊啦!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之五]]></title>
    <link href="http://kennytu.github.io/blog/2015/11/23/sails-study05/"/>
    <updated>2015-11-23T16:56:55+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/11/23/sails-study05</id>
    <content type="html"><![CDATA[<p>終於來到練習的第五集了, 這一集的影片連結是<a href="https://www.youtube.com/watch?v=_wL2cS0GmJQ&index=8&list=PLWsZeJCry-F4K4iRImeB3-i0S5mw9Ak-W" target=_blank>Building a Sails Application: Ep6 - Creating a policy and adding client-side validation</a></p>

<p>上一個單元, Irl nathan展示了如何在UserController中, 實現Handling validation errors with a flash message.</p>

<p>想當然, sails有更優雅的做法, 那就是本章要介紹的policy機制.</p>

<!--more-->


<p>先來寫程式碼</p>

<p>在<code>api\policies\</code> 創建 <code>flash.js</code>, 內如如下</p>

<figure class='code'><figcaption><span>flash.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">res</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// clear flash</span>
</span><span class='line'>  <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">next</span><span class="p">();</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>然後在 <code>config\policies.js</code> 找到</p>

<figure class='code'><figcaption><span>policies.js </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'> <span class="c1">//&#39;*&#39;: true,</span>
</span><span class='line'>   <span class="s1">&#39;*&#39;</span><span class="o">:</span> <span class="s1">&#39;flash&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣就設定完成了, 接著, 重新啟動sails</p>

<p>然後驗證一下註冊資訊若輸入錯誤, 是不是有相同的提示效果</p>

<p>基本上應該都要很順利.</p>

<p>接下來, 作者用JQuery來美化頁面上的錯誤訊息</p>

<p>首先, 我們去下載<a href="http://jqueryvalidation.org/" target=_blank>jQuery Validation Plugin</a></p>

<p>壓縮檔解壓縮之後, 在<code>dist</code>的目錄下找到<code>additional-methods.min.js</code></p>

<p>把這個檔案copy到sails專案底下的<code>assets\js\dependencies</code></p>

<p>接著修改<code>tasks\pipeline.js</code></p>

<figure class='code'><figcaption><span>pipeline.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// Client-side javascript files to inject in order</span>
</span><span class='line'><span class="c1">// (uses Grunt-style wildcard/glob/splat expressions)</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">jsFilesToInject</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Load sails.io before everything else</span>
</span><span class='line'>  <span class="s1">&#39;js/dependencies/sails.io.js&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Dependencies like jQuery, or Angular are brought in here</span>
</span><span class='line'>  <span class="s1">&#39;js/dependencies/jquery.js&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;js/dependencies/jquery.validate.min.js&#39;</span><span class="p">,</span>
</span><span class='line'>  <span class="s1">&#39;js/dependencies/**/*.js&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// All of the rest of your client-side js files</span>
</span><span class='line'>  <span class="c1">// will be injected here in no particular order.</span>
</span><span class='line'>
</span><span class='line'>  <span class="s1">&#39;js/**/*.js&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Use the &quot;exclude&quot; operator to ignore files</span>
</span><span class='line'>  <span class="c1">// &#39;!js/ignore/these/files/*.js&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意以上的程式碼, 有先後順序, jquery.js在前面, 接下來才是<code>jquery.validate.min.js</code></p>

<p>接著, 在新增<code>assets\js\dependencies\</code> 底下新增<code>customVaildate.js</code></p>

<figure class='code'><figcaption><span>customVaildate.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.form-signin&#39;</span><span class="p">).</span><span class="nx">validate</span><span class="p">({</span>
</span><span class='line'>    <span class="nx">rules</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">name</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nx">email</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nx">password</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">minlength</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="nx">confirmation</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">minlength</span><span class="o">:</span><span class="mi">6</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">equalTo</span><span class="o">:</span> <span class="s2">&quot;#password&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">element</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="s1">&#39;OK!&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;valid&#39;</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure>


<p>這個檔案會被sails自動讀取, 是因為我們在<code>pipeline.js</code>裡面有一行敘述是<code>'js/**/*.js'</code> sails會自動讀取js目錄底下所有的java script檔案</p>

<p>新增完成之後, 重新啟動sails</p>

<p>就可以看到我們的註冊畫面有Jquery的Validate的檢查樣式了</p>

<p>接著我們上下一課: <a href="https://www.youtube.com/watch?v=HozWtywQNMo&list=PLWsZeJCry-F4K4iRImeB3-i0S5mw9Ak-W&index=9" target="_blank">Building a Sails Application: Ep7 - Adding the show action.</a></p>

<p>我們要來新增<code>show</code>每一個user的基本資料的action</p>

<p>先修改UserController.js</p>

<figure class='code'><figcaption><span>UserController.js </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;new&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>        <span class="c1">//res.locals.flash = _.clone(req.session.flash);</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">();</span>
</span><span class='line'>        <span class="c1">//req.session.flash = {};</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">all</span><span class="p">(),</span> <span class="kd">function</span> <span class="nx">userCreated</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">user</span><span class="p">){</span>
</span><span class='line'>          <span class="c1">//if(err) return next(err);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">err</span><span class="o">:</span> <span class="nx">err</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">//if error redirect back to sign-up page</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/new&#39;</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>        <span class="c1">//res.json(user);</span>
</span><span class='line'>        <span class="c1">//req.session.flash = {};</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/show/&#39;</span><span class="o">+</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="c1">//render the profile view (e.g. /views/show.ejs)</span>
</span><span class='line'>    <span class="nx">show</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">){</span>
</span><span class='line'>      <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">param</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">),</span> <span class="kd">function</span> <span class="nx">foundUser</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span> <span class="nx">user</span><span class="p">){</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">user</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">({</span>
</span><span class='line'>          <span class="nx">user</span><span class="o">:</span> <span class="nx">user</span>
</span><span class='line'>        <span class="p">});</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>主要修改有<code>create</code>有一個<code>res.redirect</code>, 以及新增了一個<code>show</code>的function</p>

<p>接著在<code>views\user\</code>底下新增<code>show.ejs</code></p>

<figure class='code'><figcaption><span>show.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;container&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;&lt;%-</span> <span class="nx">user</span><span class="p">.</span><span class="nx">name</span> <span class="o">%&gt;&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;&lt;%-</span> <span class="nx">user</span><span class="p">.</span><span class="nx">title</span> <span class="o">%&gt;&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">hr</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h3</span><span class="o">&gt;</span><span class="nx">contact</span><span class="o">:</span> <span class="o">&lt;%-</span> <span class="nx">user</span><span class="p">.</span><span class="nx">email</span> <span class="o">%&gt;&lt;</span><span class="err">/h3&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">a</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-medium btn-primary&quot;</span> <span class="nx">href</span><span class="o">=</span><span class="s2">&quot;/user/edit/&lt;%= user.id %&gt;%&gt;&quot;</span><span class="o">&gt;</span><span class="nx">Edit</span><span class="o">&lt;</span><span class="err">/a&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="err">/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣,每一次在create使用者的時候, 就會導入show.ejs的頁面</p>

<p>或者可以直接輸入 <code>http://localhost:1337/user/show/2</code> 這樣的url直接查詢</p>

<p>好的, 今天的練習就到這邊</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之四]]></title>
    <link href="http://kennytu.github.io/blog/2015/11/18/sails-study04/"/>
    <updated>2015-11-18T18:38:20+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/11/18/sails-study04</id>
    <content type="html"><![CDATA[<p>OK, 接下來這篇<a href="https://www.youtube.com/watch?v=4Gbc9ZA2-YY&list=PLWsZeJCry-F4K4iRImeB3-i0S5mw9Ak-W&index=7" target="_blank">Building a Sails Application: Ep5 - Handling validation errors with a flash message</a></p>

<p>作者要示範如何handle error</p>

<p>當我們登入註冊頁面, 然後沒有輸入任何資料, 或者資料輸入錯誤, 就按下Create Account. Sails會回傳錯誤資訊. 我們現在要handle這個錯誤, 請看以下練習</p>

<!--more-->


<p>到<code>UserController.js</code>, 修改create function</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;new&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">locals</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">();</span>
</span><span class='line'>        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">all</span><span class="p">(),</span> <span class="kd">function</span> <span class="nx">userCreated</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">user</span><span class="p">){</span>
</span><span class='line'>          <span class="c1">//if(err) return next(err);</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">){</span>
</span><span class='line'>            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>            <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>              <span class="nx">err</span><span class="o">:</span> <span class="nx">err</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">//if error redirect back to sign-up page</span>
</span><span class='line'>            <span class="k">return</span> <span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s1">&#39;/user/new&#39;</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
</span><span class='line'>        <span class="nx">req</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">flash</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK.</p>

<p>然後到new.ejs,參考底下程式碼</p>

<figure class='code'><figcaption><span>new.ejs </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="o">&lt;</span><span class="nx">form</span> <span class="nx">action</span><span class="o">=</span><span class="s2">&quot;/user/create&quot;</span> <span class="nx">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-signin&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">h2</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-signin-heading&quot;</span><span class="o">&gt;</span> <span class="nx">Create</span> <span class="nx">an</span> <span class="nx">account</span><span class="o">&lt;</span><span class="err">/h2&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;%</span> <span class="k">if</span><span class="p">(</span><span class="nx">flash</span> <span class="o">&amp;&amp;</span> <span class="nx">flash</span><span class="p">.</span><span class="nx">err</span><span class="p">){</span> <span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">ul</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;alert alert-success&quot;</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="o">&lt;%</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">flash</span><span class="p">.</span><span class="nx">err</span><span class="p">).</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">){</span> <span class="o">%&gt;</span>
</span><span class='line'>    <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;&lt;%-</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">flash</span><span class="p">.</span><span class="nx">err</span><span class="p">[</span><span class="nx">error</span><span class="p">])</span> <span class="o">%&gt;&lt;</span><span class="err">/li&gt;</span>
</span><span class='line'>    <span class="o">&lt;%</span> <span class="p">})</span><span class="o">%&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/ul&gt;</span>
</span><span class='line'>  <span class="o">&lt;%</span><span class="p">}</span><span class="o">%&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">div</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-group&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;your name&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="o">&lt;</span><span class="err">/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;your title&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;title&quot;</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;email address&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;email&quot;</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;password&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;form-control&quot;</span> <span class="nx">placeholder</span><span class="o">=</span><span class="s2">&quot;password confirmation&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;confirmation&quot;</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;submit&quot;</span> <span class="kr">class</span><span class="o">=</span><span class="s2">&quot;btn btn-lg btn-primary btn-block&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;Create Account&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">&lt;</span><span class="nx">input</span> <span class="nx">type</span><span class="o">=</span><span class="s2">&quot;hidden&quot;</span> <span class="nx">name</span><span class="o">=</span><span class="s2">&quot;_csrf&quot;</span> <span class="nx">value</span><span class="o">=</span><span class="s2">&quot;&lt;%= _csrf %&gt;&quot;</span><span class="o">/&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="err">/form&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>重新啟動, 測試看看, 應該就沒問題了</p>

<p>這篇主要在講後端處理的技術, 以及在前端如何使用ejs的一些巧技巧</p>

<p>精華的部分就是在<code>res.locals.flash</code>和<code>req.session.flash</code>這兩個上面, 以及前端頁面, 像是 <code>&lt;%</code> <code>%&gt;</code>這樣嵌入式的ejs用法..</p>

<p>說實話, 我現階段還對ejs語法不是很熟, 到時候再來補齊相關資訊嚕</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之三]]></title>
    <link href="http://kennytu.github.io/blog/2015/11/18/sails-study03/"/>
    <updated>2015-11-18T12:05:14+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/11/18/sails-study03</id>
    <content type="html"><![CDATA[<p>前面兩個練習都做完之後, 我們終於有了一個還滿順眼的登入畫面</p>

<p>接下來我們按照Irl nathan的課程繼續我們的練習</p>

<p>課程連結在此 <a href="https://www.youtube.com/watch?v=WKtmKha6Ehw&index=6&list=PLWsZeJCry-F4K4iRImeB3-i0S5mw9Ak-W" target="_blank">Building a Sails Application: Ep4 - Creating a user account.</a></p>

<!--more-->


<p>在一開始, Nathan他shows了一個new.ejs的程式碼</p>

<p>你會發現它多了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;control-group&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>...
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>若你用的是bootstrap3.x的版本, 就會發生找不到control-group的class, 這時候請到<a href="http://getbootstrap.com/migration/" target="_blank">這裡</a>, 找到對照bootstrap2.x 改版到3.x有關於一些相對應class名稱的修改.你就知道要怎麼對應這些bootstrap3.x的CSS了</p>

<p>接著, Ponzi花了點時間解釋<code>&lt;%= _csrf %&gt;</code>這個tag的用意</p>

<p>我們先到config/csrf.js, 將csrf Enable起來</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="cm">/****************************************************************************</span>
</span><span class='line'><span class="cm">*                                                                           *</span>
</span><span class='line'><span class="cm">* Enabled CSRF protection for your site?                                    *</span>
</span><span class='line'><span class="cm">*                                                                           *</span>
</span><span class='line'><span class="cm">****************************************************************************/</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">csrf</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>至於CSRF是什麼東西, 之後我在整理出來寫在另一篇文章中</p>

<p>簡言之, CSRF是某種保護機制, 讓你可以識別使用者..</p>

<p>接著, 到<code>blueprints.js</code> 設定</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">actions</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'><span class="nx">rest</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'><span class="nx">shortcuts</span><span class="o">:</span> <span class="kc">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>存檔, 接著到UserController.js</p>

<p>加入以下程式碼</p>

<figure class='code'><figcaption><span>api\controllers\UserController.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;new&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">();</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">create</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">User</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">params</span><span class="p">.</span><span class="nx">all</span><span class="p">(),</span> <span class="kd">function</span> <span class="nx">userCreated</span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="nx">user</span><span class="p">){</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="k">return</span> <span class="nx">next</span><span class="p">(</span><span class="nx">err</span><span class="p">);</span>
</span><span class='line'>          <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span>
</span><span class='line'>      <span class="p">});</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>主要是新增<code>create</code>這個method.</p>

<p>從新啟動sails</p>

<p><code>sails lift</code></p>

<p>輸入<code>http://localhost:1337</code>, 點擊 sing up now, 進入登錄畫面</p>

<p>輸入必要的資訊之後, 按下Create an account, 此時Sails會回傳下列的資訊</p>

<figure class='code'><figcaption><span>http://localhost:1337/user/create的返回資訊</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;kg&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;kaaa&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;k223@hot.com&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;password&quot;</span><span class="p">:</span> <span class="s2">&quot;1234&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;comfirmation&quot;</span><span class="p">:</span> <span class="s2">&quot;5678&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;_csrf&quot;</span><span class="p">:</span> <span class="s2">&quot;gdMb0LUb-zUlpCgAUgC0LW41ILym6M6_svV4&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2015-11-18T09:20:31.268Z&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;updatedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2015-11-18T09:20:31.268Z&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>GOOD, 大功告成. 現在美中不足的就是密碼部分會是明碼的格式傳回, 這個我們馬上來處理</p>

<p>我們到<code>User.js</code>, 也就是<code>api\models\User.js</code></p>

<p>加入底下的程式碼</p>

<figure class='code'><figcaption><span>User.js</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">toJSON</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">obj</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">toObject</span><span class="p">();</span>
</span><span class='line'>      <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
</span><span class='line'>      <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">confirmation</span><span class="p">;</span>
</span><span class='line'>      <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">encryptedPassword</span><span class="p">;</span>
</span><span class='line'>      <span class="k">delete</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">_csrf</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="nx">obj</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>將toJSON加入, 然後重新啟動Sails</p>

<p>我們在測試一次, 就可以看到回傳的資訊已經隱藏了<code>password</code>, <code>confirmation</code>, <code>encryptedPassword</code>以及<code>_csrf</code></p>

<p>測試內容如下</p>

<figure class='code'><figcaption><span>http://localhost:1337/user/create</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;23423&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;42344&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;3242@gmail.com&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2015-11-18T09:34:28.608Z&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;updatedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2015-11-18T09:34:28.608Z&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>我們發現回傳的已經沒有敏感的資訊了.</p>

<p>另一方面, sails有更優雅的解決方案, sails提供了在model的一個Setting, 叫做<code>schema</code>, 若把<code>schema</code>設為<code>true</code>, 那麼<code>sails</code>只會保存在model中有定義的屬性, 若為false, 那麼sails就允許你可以任意儲存你想要的record的資料</p>

<p>官方網站的資料請參考<a href="http://sailsjs.org/documentation/concepts/models-and-orm/model-settings#?schema" target="_blank">這裡</a></p>

<p>我們修改User.js, 把toJSON拿掉, 加入schema</p>

<figure class='code'><figcaption><span>User.js.移除toJSON.加入schema</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">schema</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">attributes</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">name</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">title</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">email</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">encryptedPassword</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">//toJSON: function(){</span>
</span><span class='line'>    <span class="c1">//  var obj = this.toObject();</span>
</span><span class='line'>    <span class="c1">//  delete obj.password;</span>
</span><span class='line'>    <span class="c1">//  delete obj.confirmation;</span>
</span><span class='line'>    <span class="c1">//  delete obj.encryptedPassword;</span>
</span><span class='line'>    <span class="c1">//  delete obj._csrf;</span>
</span><span class='line'>    <span class="c1">//  return obj;</span>
</span><span class='line'>    <span class="c1">//}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>從新啟動sails, 然後到瀏覽器, 記得清空瀏覽器緩存, 不然會有問題</p>

<p>輸入註冊資訊, 然後看回傳的訊息</p>

<figure class='code'><figcaption><span>http://localhost:1337/user/create</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;HappyKenny&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;HappyKennyYa&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;email&quot;</span><span class="p">:</span> <span class="s2">&quot;happy@com.tw&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;id&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;createdAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2015-11-18T09:52:11.686Z&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;updatedAt&quot;</span><span class="p">:</span> <span class="s2">&quot;2015-11-18T09:52:11.686Z&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>同樣的, 沒有敏感的資訊</p>

<p>你可以在瀏覽器輸入<code>http://localhost:1337/user</code></p>

<p>來觀看以往建立的user資料</p>

<p>OK, 這堂課就到這邊, 謝謝大家</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之二]]></title>
    <link href="http://kennytu.github.io/blog/2015/11/17/sails-study02/"/>
    <updated>2015-11-17T10:54:23+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/11/17/sails-study02</id>
    <content type="html"><![CDATA[<p>本篇是接著Irl nathan的這篇</p>

<p><a href="https://www.youtube.com/watch?v=qUAzpyThAB0&index=5&list=PLWsZeJCry-F4K4iRImeB3-i0S5mw9Ak-W" target="_blank">Building a Sails Application: Ep3[UPDATED] - A user model/controller, signup page, sails blueprints</a></p>

<p>底下為練習內容</p>

<!--more-->


<h2>MVC架構</h2>

<p>Sails有支援MVC架構, 所以若你有想要完成一個概念性的物件, 這個物件有相對的屬性和行為,Sails會將這個物件的屬性放在Modules, 而行為就放在Controller</p>

<p>使用下列的語法來讓Sails自動創建Controller以及Module</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='batch'><span class='line'>E:\sails_app\activeityOverload<span class="p">&gt;</span><span class="n">sails</span> generate api user
</span><span class='line'>info: Created a new api!
</span></code></pre></td></tr></table></div></figure>


<p>PS: 舊版的只要輸入<code>sails generate user</code> 就可以了</p>

<p>這樣Sails會在</p>

<p><code>api\controllers</code> 產生 <code>UserController.js</code></p>

<p><code>api\models</code> 產生 <code>User.js</code></p>

<p>其中,</p>

<p><code>controllers</code>放的是<code>action</code>的邏輯</p>

<p><code>modules</code>裡面放的是<code>attributes</code>的設定</p>

<p>OK, 接著我們來設計User的屬性, 修改 User.js</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="nx">attributes</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">name</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">title</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">email</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;email&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">required</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">unique</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">encryptedPassword</span><span class="o">:</span><span class="p">{</span>
</span><span class='line'>        <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;string&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>要注意上面的email寫法, sails 0.10以後, type要改成'email'</p>

<p>然後原本的email: true要拿掉</p>

<p>參考<a href="https://github.com/irlnathan/activityoverlord20/issues/13" target="_blank">這裡</a></p>

<p>編輯完成之後, 存檔, 執行 <code>sails lift</code></p>

<p>若是第一次新增api, sails應該會跳出底下的訊息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='batch'><span class='line'>E:\sails_app\activeityOverload<span class="p">&gt;</span><span class="n">sails</span> lift
</span><span class='line'>
</span><span class='line'>info: Starting app...
</span><span class='line'>
</span><span class='line'>-----------------------------------------------------------------
</span><span class='line'>
</span><span class='line'> Excuse my interruption<span class="p">,</span> but it looks like this app
</span><span class='line'> does not have a project-wide <span class="s2">&quot;migrate&quot;</span> setting configured yet.
</span><span class='line'> (perhaps this is the first time you&#39;re lifting it with models?)
</span><span class='line'>
</span><span class='line'> In short<span class="p">,</span> this setting controls whether<span class="n">/how</span> Sails will attempt to automatically
</span><span class='line'> rebuild the tables<span class="n">/collections/sets/etc.</span> in your database schema.
</span><span class='line'> You can read more about the <span class="s2">&quot;migrate&quot;</span> setting here:
</span><span class='line'> http:<span class="n">//sailsjs.org/#/documentation/concepts/ORM/model-settings.html?q=migrate</span>
</span><span class='line'>
</span><span class='line'> In a production environment (NODE_ENV<span class="o">===</span><span class="s2">&quot;production&quot;</span>) Sails always uses
</span><span class='line'> migrate:<span class="s2">&quot;safe&quot;</span> to protect inadvertent deletion of your data.
</span><span class='line'> However during development<span class="p">,</span> you have a few other options <span class="k">for</span> convenience:
</span><span class='line'>
</span><span class='line'> <span class="m">1</span>. safe  - never auto-migrate my database(s). I will <span class="k">do</span> it myself (by hand)
</span><span class='line'> <span class="m">2</span>. alter - auto-migrate<span class="p">,</span> but attempt to keep my existing data (experimental)
</span><span class='line'> <span class="m">3</span>. drop  - wipe<span class="n">/drop</span> ALL my data and rebuild models every time I lift Sails
</span><span class='line'>
</span><span class='line'>What would you like Sails to <span class="k">do</span>?
</span><span class='line'>
</span><span class='line'>info: To skip this prompt in the future<span class="p">,</span> <span class="k">set</span> <span class="sb">`sails.config.models.migrate`</span>.
</span><span class='line'>info: (conventionally<span class="p">,</span> this is done in <span class="sb">`config/models.js`</span>)
</span><span class='line'>
</span><span class='line'>warn: ** <span class="k">DO</span> NOT CHOOSE <span class="s2">&quot;2&quot;</span> or <span class="s2">&quot;3&quot;</span> <span class="k">IF</span> YOU ARE WORKING WITH PRODUCTION DATA **
</span><span class='line'>
</span><span class='line'>prompt: ?:  error: Error: The hook <span class="sb">`orm`</span> is taking too long to load.
</span><span class='line'>Make sure it is triggering its <span class="sb">`initialize()`</span> callback<span class="p">,</span> or <span class="k">else</span> <span class="k">set</span> `sails.config.orm._hookTimeout to a higher value (currently <span class="m">20000</span>)
</span><span class='line'>    at tooLong [as _onTimeout] (C:\Users\KennyTu\AppData\Roaming\npm\node_modules\sails\lib\app\private\loadHooks.js:92<span class="nl">:21</span>)
</span><span class='line'>    at Timer.listOnTimeout (timers.js:89<span class="nl">:15</span>)
</span></code></pre></td></tr></table></div></figure>


<p>既然上面有提示到這個<a href="http://sailsjs.org/documentation/concepts/models-and-orm/model-settings#?migrate" target="_blank">網頁</a>, 我們就去看一下</p>

<p>大意就是說, sails他會做一些策略, 來和我們的資料庫互動, migrate(中文有遷移, 移居的意思), 有三種策略, 分別是safe, alter以及drop, 詳細我就不多說了, 去看網頁寫的很清楚</p>

<p>OK, 接下來我們要做的動作是去修改<code>config/models.js</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">models</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/***************************************************************************</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  * Your app&#39;s default connection. i.e. the name of one of your app&#39;s        *</span>
</span><span class='line'><span class="cm">  * connections (see `config/connections.js`)                                *</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  ***************************************************************************/</span>
</span><span class='line'>  <span class="c1">// connection: &#39;localDiskDb&#39;,</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/***************************************************************************</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  * How and whether Sails will attempt to automatically rebuild the          *</span>
</span><span class='line'><span class="cm">  * tables/collections/etc. in your schema.                                  *</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  * See http://sailsjs.org/#!/documentation/concepts/ORM/model-settings.html  *</span>
</span><span class='line'><span class="cm">  *                                                                          *</span>
</span><span class='line'><span class="cm">  ***************************************************************************/</span>
</span><span class='line'>   <span class="nx">migrate</span><span class="o">:</span> <span class="s1">&#39;safe&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>把migrate改成safe, 再重新執行<code>sails lift</code></p>

<p>基本上應該就沒問題可以正常執行了</p>

<p>接下來開啟瀏覽器, 輸入底下網址..</p>

<p>作者在輸入到一半的時候,故意只輸入部分, 來讓我們看一下出錯的效果</p>

<p><code>http://localhost:1337/user/create?name=kenny</code></p>

<p>伺服器回應的結果是:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;error&quot;</span><span class="o">:</span> <span class="s2">&quot;E_VALIDATION&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;status&quot;</span><span class="o">:</span> <span class="mi">400</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;summary&quot;</span><span class="o">:</span> <span class="s2">&quot;1 attribute is invalid&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;model&quot;</span><span class="o">:</span> <span class="s2">&quot;User&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;invalidAttributes&quot;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;email&quot;</span><span class="o">:</span> <span class="p">[</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;rule&quot;</span><span class="o">:</span> <span class="s2">&quot;email&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;`undefined` should be a email (instead of \&quot;null\&quot;, which is a object)&quot;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>        <span class="s2">&quot;rule&quot;</span><span class="o">:</span> <span class="s2">&quot;required&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;\&quot;required\&quot; validation rule failed for input: null&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>    <span class="p">]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>大意就是說, email需要輸入</p>

<p>我們再改一個正常的</p>

<p>在瀏覽器輸入URL如下</p>

<p><a href="http://localhost:1337/user/create?name=kennyg&amp;email=i@a.com">http://localhost:1337/user/create?name=kennyg&amp;email=i@a.com</a></p>

<p>注意email不能有用過的, 因為我們將<code>email</code>的其中一個<code>unique</code>的屬性設定為true</p>

<p>若沒有意外, 應該出現如下視窗</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;kennyg&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;email&quot;</span><span class="o">:</span> <span class="s2">&quot;i@a.com&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;createdAt&quot;</span><span class="o">:</span> <span class="s2">&quot;2015-11-17T07:19:54.897Z&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;updatedAt&quot;</span><span class="o">:</span> <span class="s2">&quot;2015-11-17T07:19:54.897Z&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">2</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>大功告成啦!</p>

<p>注意一點, 我們現在還沒有對<code>UserController.js</code>寫任何邏輯, 以上的行為都是sails系統預設的 :)</p>

<blockquote><p>預設行為都放在blueprints.js下</p></blockquote>

<p>接下來, 我們要開始弄View的東西, 之前Sails幫我們自動生成Module以及Controller,</p>

<p>我們手動在<code>views</code>新增一個資料夾<code>user</code>,然後在<code>user</code>資料夾新增一個檔案名為<code>new.ejs</code>, 新增內容如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;h1&gt;</span> User signup Form <span class="nt">&lt;/h1&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>回到<code>UserController.js</code>, 在<code>api\controllers</code>底下</p>

<p>我們新增以下的code</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s1">&#39;new&#39;</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">){</span>
</span><span class='line'>        <span class="nx">res</span><span class="p">.</span><span class="nx">view</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>重新啟動sails, 回到瀏覽器輸入localhost:1337, 按下Sing Up now, 視窗就會跳到new.ejs的page去</p>

<p>還記得嗎? 我們在static底下的index.ejs, button的href是指到/user/new這個action, 所以就會跳到new這邊來了</p>

<p>一般來說, sails會自動幫我們對應action以及底下的檔案, 若要關掉它, 就要去設定</p>

<p>現在我們修改<code>blueprints.js</code>, 在<code>config</code>底下</p>

<p>找到<code>rest</code>, 把他設定成<code>false</code>. <strong>記得要把註解拿掉</strong></p>

<p>參照以下設定</p>

<pre><code>rest: false,
shortcuts: false,
actions: false,
</code></pre>

<p>設定好, 存檔, 重新啟動sails</p>

<p>這時候進入首頁, 按下Sing up now, 我們會被導入404 pages</p>

<p>接著我們就開始手工打造我們的mapping</p>

<p>回到routes.js, 加入底下的code</p>

<figure class='code'><figcaption><span>routes.js 片段</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="s1">&#39;/&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">view</span><span class="o">:</span> <span class="s1">&#39;static/index&#39;</span>
</span><span class='line'>      <span class="p">},</span>
</span><span class='line'>      <span class="s1">&#39;/user/new&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">view</span><span class="o">:</span> <span class="s1">&#39;user/new&#39;</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>從新啟動sails, 再次執行sing up now, 就可以導向到我們的頁面了</p>

<p>另一種routes.js風格的寫法, 如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'>   <span class="s1">&#39;user/new&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">controller</span><span class="o">:</span> <span class="s2">&quot;UserController&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">action</span><span class="o">:</span><span class="s2">&quot;new&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>這樣的寫法我在新版的sails上面都沒有辦法get到頁面, 不知道是不是要明確指定view才行</p>

<p>另外, 有關routes的其他寫法, 請參考<a href="http://sailsjs.org/documentation/concepts/routes/custom-routes" target="_blank">Custom Routes</a>的 <strong>Controller / action target syntax</strong> 章節</p>

<blockquote><p>ok, 我們先繼續, 等之後有靈感在回來試試看</p></blockquote>

<p>現在先將剛剛在routes.js加入的'user/new'這一些敘述都刪掉, 存檔</p>

<p>回到<code>blueprints.js</code>, 將<code>action</code>改成<code>true</code></p>

<p>然後修改new.ejs, 如底下的程式碼</p>

<figure class='code'><figcaption><span>new.ejs</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;/user/create&quot;</span> <span class="na">method=</span><span class="s">&quot;POST&quot;</span> <span class="na">class=</span><span class="s">&quot;form-signin&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;h2</span> <span class="nt">&gt;</span> Create an account<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;your name&quot;</span> <span class="na">name=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;your title&quot;</span> <span class="na">name=</span><span class="s">&quot;title&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;email address&quot;</span> <span class="na">name=</span><span class="s">&quot;email&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;password&quot;</span> <span class="na">name=</span><span class="s">&quot;password&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;password&quot;</span> <span class="na">class=</span><span class="s">&quot;form-control&quot;</span> <span class="na">placeholder=</span><span class="s">&quot;password confirmation&quot;</span> <span class="na">name=</span><span class="s">&quot;comfirmation&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-lg btn-primary btn-block&quot;</span> <span class="na">value=</span><span class="s">&quot;Create Account&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;hidden&quot;</span> <span class="na">name=</span><span class="s">&quot;_csrf&quot;</span> <span class="na">value=</span><span class="s">&quot;&lt;%= _csrf %&gt;&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;/form&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>由於new.ejs有用到一些css, 作者也對custom.less做了一些修改</p>

<p>程式碼如下</p>

<figure class='code'><figcaption><span>custom.less</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="k">@white</span><span class="o">:</span> <span class="nf">#FFFFFF</span><span class="p">;</span>
</span><span class='line'><span class="k">@green</span><span class="o">:</span> <span class="nf">#9EC03B</span><span class="p">;</span>
</span><span class='line'><span class="k">@orange</span><span class="o">:</span> <span class="nf">#F48744</span><span class="p">;</span>
</span><span class='line'><span class="k">@blue</span><span class="o">:</span> <span class="nf">#189ECA</span><span class="p">;</span>
</span><span class='line'><span class="k">@gray</span><span class="o">:</span> <span class="nf">#777574</span><span class="p">;</span>
</span><span class='line'><span class="k">@lightGrey</span><span class="o">:</span> <span class="nf">#AAAAAA</span><span class="p">;</span>
</span><span class='line'><span class="k">@darkBlue</span><span class="o">:</span> <span class="nf">#106E8D</span><span class="p">;</span>
</span><span class='line'><span class="k">@darkGray</span><span class="o">:</span> <span class="nf">#4A4A4A</span><span class="p">;</span> <span class="o">//</span> <span class="nt">paragraphs</span>
</span><span class='line'><span class="k">@red</span><span class="o">:</span> <span class="nf">#D16565</span><span class="p">;</span> <span class="o">//</span> <span class="nt">error</span>
</span><span class='line'>
</span><span class='line'><span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">padding-top</span><span class="o">:</span> <span class="m">60px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">40px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.jumbotron</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.jumbotron</span> <span class="nt">h2</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font-size</span><span class="o">:</span> <span class="m">1.5em</span><span class="p">;</span>
</span><span class='line'>  <span class="k">letter-spacing</span><span class="o">:</span> <span class="m">-1px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">30px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>  <span class="k">font-weight</span><span class="o">:</span> <span class="k">normal</span><span class="p">;</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">gray</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.container</span> <span class="nc">.gray</span><span class="p">{</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">gray</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.container</span><span class="p">{</span>
</span><span class='line'>  <span class="o">.</span><span class="n">footer</span><span class="err">{</span>
</span><span class='line'>    <span class="k">width</span><span class="o">:</span> <span class="m">25%</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="err">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.form-signin</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">max-width</span><span class="o">:</span> <span class="m">30%</span><span class="p">;</span>
</span><span class='line'>  <span class="k">padding</span><span class="o">:</span> <span class="m">19px</span> <span class="m">29px</span> <span class="m">29px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">margin</span><span class="o">:</span> <span class="m">0</span> <span class="k">auto</span> <span class="m">20px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">margin-top</span><span class="o">:</span> <span class="m">20px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-color</span><span class="o">:</span> <span class="o">@</span><span class="n">lightGrey</span><span class="p">;</span>
</span><span class='line'>  <span class="k">border</span><span class="o">:</span> <span class="m">1px</span> <span class="k">solid</span> <span class="o">@</span><span class="nb">green</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">webkit</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">15px</span><span class="p">;</span>
</span><span class='line'>  <span class="o">-</span><span class="n">moz</span><span class="o">-</span><span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">15px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">border</span><span class="o">-</span><span class="n">radius</span><span class="o">:</span> <span class="m">15px</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">h2</span><span class="err">{</span>
</span><span class='line'>      <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>      <span class="k">margin-top</span><span class="o">:</span> <span class="m">0px</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="err">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.form-signin</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="o">],</span>
</span><span class='line'><span class="nc">.form-signin</span> <span class="nt">input</span><span class="o">[</span><span class="nt">type</span><span class="o">=</span><span class="s2">&quot;password&quot;</span><span class="o">]</span><span class="p">{</span>
</span><span class='line'>  <span class="k">font-size</span><span class="o">:</span> <span class="m">16px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">height</span><span class="o">:</span> <span class="k">auto</span><span class="p">;</span>
</span><span class='line'>  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">15px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">padding</span><span class="o">:</span> <span class="m">7px</span> <span class="m">9px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, 回到瀏覽器, 在reflash一次, 應該會出現像樣的登入畫面了</p>

<p>以上就是這一堂課的練習</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sails練習之一]]></title>
    <link href="http://kennytu.github.io/blog/2015/11/16/sails-study01/"/>
    <updated>2015-11-16T11:29:18+08:00</updated>
    <id>http://kennytu.github.io/blog/2015/11/16/sails-study01</id>
    <content type="html"><![CDATA[<p>這一系列的文章, 出自於youtube上的Building a Sails Application教學.</p>

<p>這位仁兄的一系列教學文章都寫得非常好</p>

<p>他的網址在<a href="https://www.youtube.com/watch?v=ep6EQ5f82Ts&index=2&list=PLWsZeJCry-F4K4iRImeB3-i0S5mw9Ak-W" target="_blank">這邊</a></p>

<p>然後作者的github在<a href="https://github.com/irlnathan" target="_blank">這邊</a></p>

<p>這個版本是<code>activityoverlord 1.0</code>版本</p>

<p>在2015年, Irl nathan又出了<code>activityoverlord 2.0</code>版本, 主要是用新的Sails.js來實作</p>

<p>但我在練習<code>Sails</code>的時候, 我也是用<code>新版0.11.2</code>的版本, 所以在舊版到新版的改動我也會一併在練習中說明.</p>

<p>底下分別是他的各個教學章節, 我只是用文字來記錄我的學習過程</p>

<!--more-->


<h2>Building a Sails Application: Ep1 - Installing Sails and Create Initial Project</h2>

<p>OK, 這個章節主要就是教安裝, 你要先安裝好<code>npm</code>, 接下來都好辦了</p>

<p>安裝sails</p>

<p><code>npm install -g sails</code></p>

<p>指令一下去就裝好了. -g是代表安裝到大家都可以存取到的目錄, npm的共用目錄是放在<code>C:\Users\KennyTu\AppData\Roaming\npm</code></p>

<p>你可以用npm config get prefix來取得global的目錄</p>

<p><code>E:\sails_app&gt;npm config get prefix</code></p>

<p>安裝好sails之後, 就可以用sails來create project</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='batch'><span class='line'>E:\sails_app<span class="p">&gt;</span><span class="n">sails</span> new activeityOverload --linker
</span><span class='line'>info: Created a new Sails app <span class="sb">`activeityOverload`</span>!
</span></code></pre></td></tr></table></div></figure>


<p><code>--linker</code> 的意思是在傳輸的過程啟動壓縮功能, 先讓資料變小, 然後傳輸, 節省網路開銷</p>

<p><strong>但在0.10版本之後, sails就捨棄了linker, 要注意一下</strong></p>

<p>詳情請參考<a href="http://stackoverflow.com/questions/22042260/sails-js-v0-10-create-new-project-linker-not-working-gruntfile-js-not-used" target="_blank">這裡</a></p>

<p>接著啟動sails的serve來看結果</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='batch'><span class='line'>E:\sails_app<span class="p">&gt;</span><span class="n">cd</span> activeityOverload
</span><span class='line'>E:\sails_app\activeityOverload<span class="p">&gt;</span><span class="n">sails</span> lift
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='batch'><span class='line'>info: Starting app...
</span><span class='line'>
</span><span class='line'>info:
</span><span class='line'>info:                .-..-.
</span><span class='line'>info:
</span><span class='line'>info:    Sails              &lt;|    .-..-.
</span><span class='line'>info:    v<span class="m">0</span>.<span class="m">11</span>.<span class="m">2</span>             |\
</span><span class='line'>info:                       <span class="n">/|.\</span>
</span><span class='line'>info:                      / || \
</span><span class='line'>info:                    <span class="p">,</span><span class="s1">&#39;  |&#39;</span>  \
</span><span class='line'>info:                 .-<span class="s1">&#39;.-==|/_--&#39;</span>
</span><span class='line'>info:                 `--<span class="s1">&#39;-------&#39;</span>
</span><span class='line'>info:    __---___--___---___--___---___--___
</span><span class='line'>info:  ____---___--___---___--___---___--___-__
</span><span class='line'>info:
</span><span class='line'>info: Server lifted in <span class="sb">`E:\sails_app\activeityOverload`</span>
</span><span class='line'>info: To see your app<span class="p">,</span> visit http:<span class="n">//localhost:1337</span>
</span><span class='line'>info: To shut down Sails<span class="p">,</span> press <span class="p">&lt;</span><span class="n">CTRL</span>&gt; + C at any time.
</span><span class='line'>
</span><span class='line'>debug: --------------------------------------------------------
</span><span class='line'>debug: <span class="c">:: Mon Nov 16 2015 15:24:06 GMT+0800 (台北標準時間)</span>
</span><span class='line'>
</span><span class='line'>debug: Environment : development
</span><span class='line'>debug: Port        : <span class="m">1337</span>
</span><span class='line'>debug: --------------------------------------------------------
</span></code></pre></td></tr></table></div></figure>


<p>看到以上的訊息之後, 就可以到瀏覽器中輸入 <code>http://localhost:1337</code></p>

<p>就可以看到網頁啦!</p>

<p>好~ 第一課就是這樣囉, 結束</p>

<p>底下是第二課</p>

<h2>Building a Sails Application: Ep2 - Creating a sign-up page, adding twitter bootstrap</h2>

<p>進入到我們剛剛create的資料夾, 也就是activeityOverload, 我們會看到幾個資料夾和檔案</p>

<p>我們先專注在 <code>config/routes.js</code></p>

<p>這個檔案決定使用者個要求如何導向我們設定的資源</p>

<p>詳細的介紹在<a href="http://sailsjs.org/#!/documentation/concepts/Routes/RouteTargetSyntax.html" target="_blank">這邊</a></p>

<p>主要是這個結構</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">routes</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="s1">&#39;/&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">view</span><span class="o">:</span> <span class="s1">&#39;homepage&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>這個是說, 根目錄的頁面是呈現主要是view的hompage檔案</p>

<p>所以我們可以在views的目錄下找到homepage.ejs</p>

<p>EJS 是一個 client 端的 JavaScript template library，可以讓整個網頁程式碼結構更清楚、更整潔。有興趣的人可以參考<a href="http://blogger.gtwang.org/2014/02/ejs-embedded-javascript.html" target="_blank">這裡</a></p>

<p>現在呢, 我們要做以下事情</p>

<ol>
<li>在views下create一個資料夾static</li>
<li>在static資料夾下新增index.ejs</li>
</ol>


<p>在index.ejs新增</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;h1&gt;</span> this is our homepage <span class="nt">&lt;/h1&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>回到<code>config/routes.js</code> 修改我們的首頁的目錄, 如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">routes</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="s1">&#39;/&#39;</span><span class="o">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">view</span><span class="o">:</span> <span class="s1">&#39;static/index&#39;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>修改完成, 重新啟動sails,</p>

<p><code>sails lift</code></p>

<p>然後到瀏覽器(在這邊我用Firefox)就可以看到結果</p>

<p>在這邊用瀏覽器的觀看原始碼功能, 會看到source code多了很多東西出來</p>

<p>這是因為sails會用layout.ejs (在views底下)</p>

<p>重新幫我們產生出一個頁面出來</p>

<p>為了實驗一下layout.ejs, 我們來修改一下內容</p>

<p>在layout.ejs檔案中, 大約31行開始</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="c">&lt;!--STYLES--&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/styles/bootstrap.css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href=</span><span class="s">&quot;/styles/importer.css&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="c">&lt;!--STYLES END--&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>上面那個<code>bootstrap.css</code>是我加的</p>

<p>目的是在於, 我們改用<code>bootstrap.css</code>來重新render(渲染)我們的html元素</p>

<p>也就是我們的<code>index.ejs</code>當中的<code>h2</code>的元素, 會被<code>layout.ejs</code>用<code>bootstrap.css</code>來重新渲染</p>

<p>底下是作法</p>

<ol>
<li>去下載bootstrap, 最新的是bootstrap-3.3.5-dist.zip, 裡面有js, css, fonts</li>
<li>把css下面的bootstrap.css copy 到 sails app 目錄下的 <code>activeityOverload\assets\styles</code></li>
<li>到layout.ejs去新增 styles, 就如同上面的layout.ejs的範例一樣</li>
</ol>


<p>接著就是重新啟動sails, 你會看到首頁的字型變得不太一樣了</p>

<p>在這邊要提到一個目錄, 也就是assets, assets中文是資源的意思, 意思就是你create的任何files都可以放在這個資料夾啦!</p>

<p>當我們把files放到這個assets的目錄時, sails會在啟動的時候, 將底下的檔案copy到要發行的另外一個目錄, 在這邊是<code>.tmp\public\styles</code></p>

<p>OK, 接下來作者就要再次修改主頁了, 修改之前, 他shows出了Gruntfile.js,</p>

<p>看到這邊出現了一個不熟悉的東西, 就上網google了一下</p>

<p>原來grunt是一個前端的建構工具, 他很像C的Make, Java的Ant, Ruby的Rake&hellip;</p>

<p>在前端和Node.js的開發環境中, 就是使用grunt來建置</p>

<p>Grunt是一個Task Runner，常用來執行 JS/CSS 打包壓縮、SASS/LESS/CoffeeScript 編譯、單元測試… 等工作，常被拿來當成前端開發自動化的引擎。</p>

<p>上網study了一下, 發現(2015年)出現了一個比Grunt更好用的Tool, 叫作Gulp</p>

<p>可能作者在出這個教學影片的時候, 還沒有Gulp, 所以就用了Grunt.</p>

<p>但既然已經有了Gulp, 我就來用Gulp來取代Grunt吧(以後啦!)</p>

<p>Sails的官網有教學, 如何把Grunt給DISABLE掉&hellip;請參考<a href="http://sailsjs.org/documentation/concepts/assets/disabling-grunt" target="_blank">官方網站</a></p>

<p>一些gulp的教學文件我列在底下</p>

<p><a href="http://www.oxxostudio.tw/articles/201503/gulp-install-webserver.html" target="_blank">Gulp 學習 1</a></p>

<p><a href="http://www.jianshu.com/p/3779f708f5d7" target="_blank">Gulp 挑戰 Grunt，背後的哲學 </a></p>

<p><a href="http://blog.darkthread.net/post-2014-09-25-gulp-grunt-bower-npm.aspx" target="_blank">Gulp, Grunt, Bower 以及 npm</a></p>

<p><a href="http://koanda.de/blog/53b9a67acba90doc1636380824-How-to-disable-Grunt-in-Sails-js" target="_blank">How to disable Grunt in Sails.js</a></p>

<p>好, 現在繼續, 在這邊有個小插曲</p>

<p>作者忘記把JQuery以及一些相關的檔案加進來, 他額外寫了一個blog, 參考
<a href="https://www.youtube.com/watch?v=zootilxmo4M" target="_blank">Building a Sails Application: Ep2a - adding jquery, custom.less, minor footer changes</a></p>

<p>底下是步驟</p>

<ol>
<li>先把JQuery下載下來, 我下載的是<a href="http://jquery.com/download/" target="_blank">The compressed, production jQuery 2.1.4</a></li>
<li>把jquery-2.1.4.min.js 改名成jquery.js, 放到assets\js\dependencies底下</li>
<li>到task\底下,找到<code>pipeline.js</code> (新的Sails把Grunt關於inject的部份放到tasks裡面的<code>pipeline.js</code>), 參考<a href="http://sailsjs.org/documentation/concepts/assets/task-automation" target="_blank">這裡</a></li>
<li>本來我們要把jquery放到pipeline.js, 結果發現pipeline.js已經幫我們處理好了</li>
</ol>


<p>從程式碼當中可以看到</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="c1">// Client-side javascript files to inject in order</span>
</span><span class='line'><span class="c1">// (uses Grunt-style wildcard/glob/splat expressions)</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">jsFilesToInject</span> <span class="o">=</span> <span class="p">[</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Load sails.io before everything else</span>
</span><span class='line'>  <span class="s1">&#39;js/dependencies/sails.io.js&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Dependencies like jQuery, or Angular are brought in here</span>
</span><span class='line'>  <span class="s1">&#39;js/dependencies/**/*.js&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// All of the rest of your client-side js files</span>
</span><span class='line'>  <span class="c1">// will be injected here in no particular order.</span>
</span><span class='line'>  <span class="s1">&#39;js/**/*.js&#39;</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Use the &quot;exclude&quot; operator to ignore files</span>
</span><span class='line'>  <span class="c1">// &#39;!js/ignore/these/files/*.js&#39;</span>
</span><span class='line'><span class="p">];</span>
</span></code></pre></td></tr></table></div></figure>


<p>OK, 所以我們就不用修改, 把jquery放到正確的目錄就好</p>

<p>接著新增<code>custom.less</code>
參考下面的內容, 放到<code>assets\styles</code>中</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nt">body</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">padding-top</span><span class="o">:</span> <span class="m">60px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">padding-bottom</span><span class="o">:</span> <span class="m">40px</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.jumbotron</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.jumbotron</span> <span class="nt">h2</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font-size</span><span class="o">:</span> <span class="m">1.5em</span><span class="p">;</span>
</span><span class='line'>  <span class="k">letter-spacing</span><span class="o">:</span> <span class="m">-1px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">margin-bottom</span><span class="o">:</span> <span class="m">30px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">center</span><span class="p">;</span>
</span><span class='line'>  <span class="k">font-weight</span><span class="o">:</span> <span class="k">normal</span><span class="p">;</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">gray</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.container</span> <span class="nc">.gray</span><span class="p">{</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">gray</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nc">.container</span><span class="p">{</span>
</span><span class='line'>  <span class="o">.</span><span class="n">footer</span><span class="err">{</span>
</span><span class='line'>    <span class="k">width</span><span class="o">:</span> <span class="m">25%</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>接著, 我們修改importer.less, 新增<code>@import 'custom.less';</code> 如下表</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="o">//</span> <span class="nt">For</span> <span class="nt">example</span><span class="o">:</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="o">//</span> <span class="k">@import</span> <span class="s1">&#39;variables/colors.less&#39;</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span> <span class="k">@import</span> <span class="s1">&#39;mixins/foo.less&#39;</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span> <span class="k">@import</span> <span class="s1">&#39;mixins/bar.less&#39;</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span> <span class="k">@import</span> <span class="s1">&#39;mixins/baz.less&#39;</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="o">//</span> <span class="k">@import</span> <span class="s1">&#39;styleguide.less&#39;</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span> <span class="k">@import</span> <span class="s1">&#39;pages/login.less&#39;</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span> <span class="k">@import</span> <span class="s1">&#39;pages/signup.less&#39;</span><span class="p">;</span>
</span><span class='line'><span class="o">//</span>
</span><span class='line'><span class="o">//</span> <span class="nt">etc</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="k">@import</span> <span class="s1">&#39;custom.less&#39;</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>PS: 我剛剛把custom.less放到assets\styles中的時候, layout.ejs好像就會幫我把custom.css自動加到STYLE裡面去.. 超強的&hellip; 還是我自己之前有改過我忘記了&hellip; XD</p>

<p>作者有在layout.ejs新增了一些屬性, <code>navbar</code>以及<code>footer</code></p>

<p>相關程式碼我寫在下面</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;navbar navbar-inverse navbar-fixed-top&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>          <span class="nt">&lt;a</span> <span class="na">class=</span><span class="s">&quot;navbar-brand&quot;</span> <span class="na">href=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span> activityOverload<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="err">&lt;</span>%- body %&gt;
</span><span class='line'>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;hr&gt;</span>
</span><span class='line'>    <span class="nt">&lt;footer</span> <span class="na">class=</span><span class="s">&quot;footer pull-right&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;div&gt;</span>
</span><span class='line'>        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;http://sailsja.com&quot;</span><span class="nt">&gt;</span>sails.js<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>        <span class="nt">&lt;div&gt;</span>Tutorial by irl nathan...<span class="nt">&lt;/div&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/footer&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中 &lt;%- body %> 上面的code是navbar, 下面的是footer</p>

<p>好的, 總之大功告成啦</p>

<p>現在要回頭修改index.ejs了</p>

<p>內容如下</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;container&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;jumbotron&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;h1&gt;</span>activityOverload<span class="nt">&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;h2&gt;</span>...tracking app activity better than the NSA since 1899.<span class="nt">&lt;/h2&gt;</span>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;text-center&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;/user/new&quot;</span> <span class="na">style=</span><span class="s">&quot;text-align:center&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-lg btn-success&quot;</span><span class="nt">&gt;</span>Sign up now!<span class="nt">&lt;/a&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>  <span class="nt">&lt;/div&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>其中如果照著youtube上面寫的, button不會置中, 所以我就加了<code>div class="text-center"</code> 讓button置中, 我們使用的class是bootstrap的class, 請參考<a href="http://stackoverflow.com/questions/22578853/how-to-center-buttons-in-twitter-bootstrap-3" target="_balnk">這裡</a></p>

<p>好, 以上就是教學影片的第一課以及第二課, 附上網址</p>

<ol>
<li><a href="https://www.youtube.com/watch?v=1H0UfbGdwd8&list=PLWsZeJCry-F4K4iRImeB3-i0S5mw9Ak-W&index=1" target="_blank">activityOverlord - An overview of the project</a></li>
<li><a href="https://www.youtube.com/watch?v=ep6EQ5f82Ts&list=PLWsZeJCry-F4K4iRImeB3-i0S5mw9Ak-W&index=2" target="_blank">Building a Sails Application: Ep1 - Installing Sails and Create Initial Project</a></li>
<li><a href="http://irlnathan.github.io/sailscasts/blog/2013/08/22/building-a-sails-application-ep2a-a-quick-supplement-to-some-stuff-i-forgot-to-mention-in-episode-2/" target="_blank">Building a Sails Application: Ep2a - Stuff I Forgot to Mention in Episode two&hellip;because I&rsquo;m Old.</a></li>
<li><a href="https://www.youtube.com/watch?v=ZE7ye2G_H9Q&list=PLWsZeJCry-F4K4iRImeB3-i0S5mw9Ak-W&index=3" target="_blank">Building a Sails Application: Ep2 - Creating a sign-up page, adding twitter bootstrap</a></li>
</ol>

]]></content>
  </entry>
  
</feed>
