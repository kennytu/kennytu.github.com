---
layout: post
title: "Sails練習之九-加密"
date: 2015-12-01 17:39:08 +0800
comments: true
categories: sails
---

OK, 上課的影片是: <a href="https://www.youtube.com/watch?v=1wziI6l0NyE" target="_blank">Building a Sails Application: Ep11 - Encrypting passwords with bcrypt.</a>


到<a href="https://www.npmjs.com/package/bcrypt" target="_blank">Bcrypt</a>看一下相關的資訊

安裝的步驟如下

到專案目錄, 執行`npm install bcrypt --save` 

加上`--save`的意思是除了install bcrypt到專案底下之外, 也把相依性設定寫入package.json, 這樣以後如果有人想要直接使用這個專案, 在目錄底下輸入npm install, 就可以將此專案需要用到的packages一次設定完成!

另外安裝`bcrypt`需要Visual Studio 2013的支援, 若你的Visual Studio版本大於2013, 請在安裝的時候再加入`--msvs_version=2013`

也就是`npm install bcrypt --save --msvs_version=2013` 

<!--more-->

OK, 安裝順利的話, 會出現如下的訊息

```batch

E:\sails_app\activeityOverload>npm install bcrypt --save
-
> bcrypt@0.8.5 install E:\sails_app\activeityOverload\node_modules\bcrypt
> node-gyp rebuild


E:\sails_app\activeityOverload\node_modules\bcrypt>if not defined npm_config_node_gyp (node "C:\Program Files\nodejs\node_modules\npm\bin\node-gyp-bin\\..\..\node_modules\node-gyp\bin\node-gyp.js" rebuild )  else (node  rebuild )

在這個方案中一次建置一個專案。若要啟用平行組建，請加入 "/m" 參數。 (Visual Studio 2013 C++ Support)
  blowfish.cc
  bcrypt.cc
..\src\bcrypt.cc(232): warning C4267: '=' : conversion from 'size_t' to 'unsigned char', possible loss of data 
[E:\sails_app\activeityOverload\node_modules\bcrypt\build\bcrypt_lib.vcxproj]  bcrypt_node.cc ..\src\bcrypt_node.cc(76): warning C4244: 'argument' : conversion from 'ssize_t' to 'unsigned char', possible loss  of data 

[E:\sails_app\activeityOverload\node_modules\bcrypt\build\bcrypt_lib.vcxproj]
..\src\bcrypt_node.cc(135): warning C4244: 'argument' : conversion from 'const ssize_t' to 'unsigned char', possible loss of data 

[E:\sails_app\activeityOverload\node_modules\bcrypt\build\bcrypt_lib.vcxproj]
..\src\bcrypt_node.cc(229): warning C4267: 'initializing' : conversion from 'size_t' to 'int', possible loss of data 

[E:\sails_app\activeityOverload\node_modules\bcrypt\build\bcrypt_lib.vcxproj]
..\src\bcrypt_node.cc(230): warning C4267: 'initializing' : conversion from 'size_t' to 'int', possible loss of data 

[E:\sails_app\activeityOverload\node_modules\bcrypt\build\bcrypt_lib.vcxproj]
win_delay_load_hook.c

Creating library E:\sails_app\activeityOverload\node_modules\bcrypt\build\Release\bcrypt_lib.lib and 
object E:\sails_app\activeityOverload\node_modules\bcrypt\build\Release\bcrypt_lib.exp
  Generating code
  Finished generating code
  bcrypt_lib.vcxproj -> E:\sails_app\activeityOverload\node_modules\bcrypt\build\Release\\bcrypt_lib.node

bcrypt@0.8.5 node_modules\bcrypt
├── bindings@1.2.1
└── nan@2.0.5

```

裝完之後, 接著我們修改`activeityOverload\api\models\`底下的`User.js`


```js User.js 新增beforeCreate Function

module.exports = {

  schema: true,

  attributes: {...},

  beforeCreate: function (values, next) {

    // This checks to make sure the password and password confirmation match before creating record
    if (!values.password || values.password != values.confirmation) {
      return next({err: ["Password doesn't match password confirmation."]});
    }

    require('bcrypt').hash(values.password, 10, function passwordEncrypted(err, encryptedPassword) {
      if (err) return next(err);
      values.encryptedPassword = encryptedPassword;
      // values.online= true;
      next();
    });
  }
};


```

新增完成之後, 重啟sails, (啟動sails之前記得要先啟動mongo db)

接著新增一名使用者看看, 新增完成之後, 使用`mongo-express`登入進去mongo db的後台去看, 我們的新的使用者是不是有已經加密過的密碼了!

好的, 大致上是這樣嚕